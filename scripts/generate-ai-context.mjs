#!/usr/bin/env node
// ══════════════════════════════════════════════════════════════
//  generate-ai-context.mjs — Generates distilled AI context from product data
//  Usage: node scripts/generate-ai-context.mjs <productId>
//  Output: products/<productId>/ai-context.js
// ══════════════════════════════════════════════════════════════

const productId = process.argv[2];
if (!productId) {
  console.error('Usage: node scripts/generate-ai-context.mjs <productId>');
  process.exit(1);
}

const dataModule = await import(`../products/${productId}/data.js`);
const configModule = await import(`../products/${productId}/config.js`);

const PRODUCT = dataModule.PRODUCT;
const config = configModule.default;

const domainEntries = Object.entries(PRODUCT);
const totalComponents = domainEntries.reduce((sum, [, d]) => sum + (d.components || []).length, 0);

let context = `You are an expert on Salesforce ${config.fullName || config.name} (${config.id.toUpperCase()}) ${config.version || ''}.
Answer questions based ONLY on the following product knowledge. If the question is not about ${config.id.toUpperCase()} or you are unsure, say so clearly. Keep answers concise (2-4 sentences).

## Domains (${domainEntries.length})
`;

for (const [id, domain] of domainEntries) {
  // Truncate description to first 2 sentences
  const desc = (domain.description || '').split('. ').slice(0, 2).join('. ');
  context += `- **${domain.name}** (${id}): ${desc}.\n`;
}

context += `\n## Key Components (${totalComponents})\n`;

for (const [id, domain] of domainEntries) {
  for (const comp of (domain.components || [])) {
    // First sentence of desc only
    const desc = (comp.desc || '').split('. ')[0];
    context += `- ${comp.name} [${domain.name}]: ${desc}.\n`;
  }
}

// Build glossary from common abbreviations
context += `
## Glossary
TDTM = Table-Driven Trigger Management, GAU = General Accounting Unit, RD2 = Enhanced Recurring Donations v2, OCR = Opportunity Contact Role, CRLP = Customizable Rollups, BDI = Batch Data Import, BGE = Batch Gift Entry, NPSP = Nonprofit Success Pack, HH = Household, PMT = Payment, OPP = Opportunity, LWC = Lightning Web Component, ADDR = Address Management, AFFL = Affiliations, REL = Relationships, ERR = Error Handling, UTIL = Utilities

## Data Flow Connections
`;

for (const [id, domain] of domainEntries) {
  if (domain.connections && domain.connections.length > 0) {
    const conns = domain.connections.map(c => `${c.planet}: ${c.desc}`).join('; ');
    context += `- ${domain.name} connects to: ${conns}\n`;
  }
}

// Write the file
const outputPath = new URL(`../products/${productId}/ai-context.js`, import.meta.url).pathname;
const fileContent = `// Auto-generated by scripts/generate-ai-context.mjs
// Do not edit manually. Regenerate with: node scripts/generate-ai-context.mjs ${productId}
export const AI_CONTEXT = ${JSON.stringify(context)};
`;

const fs = await import('fs');
fs.writeFileSync(outputPath, fileContent, 'utf-8');

const tokens = Math.round(context.length / 4); // rough token estimate
console.log(`Generated ${outputPath}`);
console.log(`${domainEntries.length} domains, ${totalComponents} components`);
console.log(`~${context.length} chars, ~${tokens} tokens`);
