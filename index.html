<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>NPSP Galaxy Explorer</title>
<style>
  :root {
    --bg-deep: #050510;
    --bg-panel: rgba(10, 15, 30, 0.92);
    --bg-card: rgba(15, 22, 45, 0.95);
    --border-glow: rgba(100, 140, 255, 0.3);
    --accent-blue: #4d8bff;
    --accent-cyan: #00d4ff;
    --accent-purple: #a855f7;
    --accent-green: #22c55e;
    --accent-orange: #f59e0b;
    --accent-pink: #ec4899;
    --accent-red: #ef4444;
    --accent-teal: #14b8a6;
    --accent-lime: #84cc16;
    --accent-rose: #f43f5e;
    --accent-indigo: #6366f1;
    --accent-amber: #d97706;
    --accent-sky: #0ea5e9;
    --accent-emerald: #10b981;
    --accent-violet: #7c3aed;
    --accent-fuchsia: #d946ef;
    --text-primary: #e2e8f0;
    --text-secondary: #94a3b8;
    --text-dim: #64748b;
    --transition-zoom: 0.8s cubic-bezier(0.22, 1, 0.36, 1);
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    font-family: 'SF Mono', 'Fira Code', 'Cascadia Code', 'JetBrains Mono', monospace;
    background: var(--bg-deep); color: var(--text-primary);
    overflow: hidden; height: 100vh; width: 100vw;
  }
  #starfield { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; pointer-events: none; }

  /* Nav */
  #navbar {
    position: fixed; top: 0; left: 0; right: 0; z-index: 100;
    display: flex; align-items: center; justify-content: space-between;
    padding: 10px 24px; background: linear-gradient(180deg, rgba(5,5,16,0.97) 0%, rgba(5,5,16,0.8) 100%);
    border-bottom: 1px solid var(--border-glow); backdrop-filter: blur(12px);
  }
  #navbar .logo { font-size: 13px; font-weight: 700; letter-spacing: 2px;
    background: linear-gradient(135deg, var(--accent-blue), var(--accent-cyan));
    -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent; }
  #navbar .logo span { font-weight: 400; opacity: 0.6; }
  #breadcrumb { display: flex; align-items: center; gap: 8px; font-size: 12px; }
  .crumb { color: var(--text-secondary); cursor: pointer; padding: 4px 10px; border-radius: 4px; transition: all 0.2s; }
  .crumb:hover { background: rgba(77,139,255,0.15); color: var(--accent-blue); }
  .crumb.active { color: var(--accent-cyan); font-weight: 600; }
  .crumb-sep { color: var(--text-dim); font-size: 10px; }
  #zoom-indicator { font-size: 11px; color: var(--text-dim); display: flex; align-items: center; gap: 8px; }
  .zoom-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--text-dim); transition: all 0.3s; }
  .zoom-dot.active { background: var(--accent-cyan); box-shadow: 0 0 8px var(--accent-cyan); }

  /* Search */
  #search-overlay {
    position: fixed; top: 0; left: 0; right: 0; bottom: 0; z-index: 200;
    background: rgba(5,5,16,0.85); backdrop-filter: blur(16px);
    display: none; flex-direction: column; align-items: center; padding-top: 12vh;
  }
  #search-overlay.open { display: flex; }
  .search-container { width: 600px; max-width: 90vw; }
  .search-input-wrap {
    position: relative; display: flex; align-items: center;
    background: rgba(15, 22, 45, 0.95); border: 1px solid rgba(100, 140, 255, 0.35);
    border-radius: 12px; padding: 4px; box-shadow: 0 0 40px rgba(77,139,255,0.15), 0 20px 60px rgba(0,0,0,0.4);
    transition: border-color 0.3s, box-shadow 0.3s;
  }
  .search-input-wrap:focus-within {
    border-color: var(--accent-cyan); box-shadow: 0 0 60px rgba(0,212,255,0.2), 0 20px 60px rgba(0,0,0,0.4);
  }
  .search-icon { padding: 12px 8px 12px 16px; color: var(--text-dim); font-size: 16px; }
  #searchInput {
    flex: 1; background: none; border: none; outline: none;
    color: var(--text-primary); font-family: inherit; font-size: 16px; padding: 12px 8px;
  }
  #searchInput::placeholder { color: var(--text-dim); }
  .search-nav { display: flex; align-items: center; gap: 4px; padding-right: 8px; }
  .search-count { font-size: 11px; color: var(--text-dim); white-space: nowrap; padding: 0 8px; }
  .search-nav-btn {
    background: rgba(100,140,255,0.1); border: 1px solid rgba(100,140,255,0.2);
    color: var(--text-secondary); width: 28px; height: 28px; border-radius: 6px;
    display: flex; align-items: center; justify-content: center;
    cursor: pointer; font-family: inherit; font-size: 14px; transition: all 0.2s;
  }
  .search-nav-btn:hover { background: rgba(100,140,255,0.2); color: var(--accent-blue); border-color: var(--accent-blue); }
  .search-close {
    background: none; border: none; color: var(--text-dim); font-size: 11px;
    padding: 6px 12px; cursor: pointer; font-family: inherit; transition: color 0.2s;
  }
  .search-close:hover { color: var(--text-primary); }
  .search-hint { font-size: 10px; color: var(--text-dim); margin-top: 12px; text-align: center; }
  .search-hint kbd { background: rgba(100,140,255,0.1); padding: 2px 6px; border-radius: 3px; font-family: inherit; border: 1px solid rgba(100,140,255,0.2); }

  /* Search Results */
  .search-results { margin-top: 16px; max-height: 50vh; overflow-y: auto; display: flex; flex-direction: column; gap: 4px; }
  .search-result {
    display: flex; align-items: center; gap: 12px;
    padding: 12px 16px; border-radius: 8px;
    background: rgba(15, 22, 45, 0.8); border: 1px solid rgba(100,140,255,0.08);
    cursor: pointer; transition: all 0.2s;
  }
  .search-result:hover, .search-result.active {
    background: rgba(77,139,255,0.12); border-color: rgba(77,139,255,0.3); transform: translateX(4px);
  }
  .search-result .sr-icon {
    width: 36px; height: 36px; border-radius: 8px;
    display: flex; align-items: center; justify-content: center; font-size: 18px; flex-shrink: 0;
  }
  .search-result .sr-body { flex: 1; min-width: 0; }
  .search-result .sr-title { font-size: 13px; font-weight: 600; margin-bottom: 2px; }
  .search-result .sr-path { font-size: 10px; color: var(--text-dim); }
  .search-result .sr-desc { font-size: 11px; color: var(--text-secondary); margin-top: 4px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
  .search-result .sr-match { color: var(--accent-cyan); font-weight: 600; }
  .sr-level { font-size: 9px; padding: 2px 8px; border-radius: 4px; white-space: nowrap; background: rgba(100,140,255,0.1); color: var(--accent-blue); }

  /* Stage */
  #stage { position: relative; width: 100vw; height: 100vh; perspective: 1200px; overflow: hidden; }
  .view-layer {
    position: absolute; top: 0; left: 0; width: 100%; height: 100%;
    display: flex; align-items: center; justify-content: center;
    transition: opacity var(--transition-zoom), transform var(--transition-zoom);
    pointer-events: none; opacity: 0;
  }
  .view-layer.active { pointer-events: auto; opacity: 1; }
  .view-layer.zoom-out { transform: scale(2.5) translateZ(200px); opacity: 0; filter: blur(4px); }
  .view-layer.zoom-in { transform: scale(0.3) translateZ(-400px); opacity: 0; filter: blur(4px); }

  /* Galaxy */
  #galaxy-view { flex-direction: column; padding-top: 50px; }
  .galaxy-title { text-align: center; margin-bottom: 8px; z-index: 2; }
  .galaxy-title h1 {
    font-size: 24px; font-weight: 800; letter-spacing: 4px;
    background: linear-gradient(135deg, #fff 0%, var(--accent-cyan) 50%, var(--accent-purple) 100%);
    -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 4px;
  }
  .galaxy-title p { font-size: 11px; color: var(--text-secondary); max-width: 600px; line-height: 1.5; margin: 0 auto; }
  .galaxy-subtitle { font-size: 9px; color: var(--text-dim); margin-top: 4px; letter-spacing: 1px; }
  #galaxy-map { position: relative; width: 1100px; height: 600px; z-index: 2; }
  .planet {
    position: absolute; display: flex; flex-direction: column; align-items: center;
    cursor: pointer; transition: all 0.4s cubic-bezier(0.22, 1, 0.36, 1);
  }
  .planet:hover { transform: scale(1.15); }
  .planet:hover .planet-ring { opacity: 1; }
  .planet:hover .planet-label { color: #fff; }
  .planet.highlight .planet-orb { box-shadow: 0 0 30px var(--accent-cyan), 0 0 80px rgba(0,212,255,0.4) !important; }
  .planet-orb {
    width: var(--size); height: var(--size); border-radius: 50%;
    box-shadow: 0 0 20px var(--color), 0 0 60px color-mix(in srgb, var(--color) 30%, transparent);
    position: relative; z-index: 2; display: flex; align-items: center; justify-content: center;
    font-size: calc(var(--size) * 0.35); animation: pulse 4s ease-in-out infinite; animation-delay: var(--delay, 0s);
  }
  .planet-ring {
    position: absolute; top: 50%; left: 50%;
    width: calc(var(--size) + 24px); height: calc(var(--size) + 24px);
    margin-top: calc((var(--size) + 24px) / -2); margin-left: calc((var(--size) + 24px) / -2);
    border-radius: 50%; border: 1px solid color-mix(in srgb, var(--color) 40%, transparent);
    opacity: 0; transition: opacity 0.3s; z-index: 1;
  }
  .planet-label { margin-top: 6px; font-size: 9px; font-weight: 600; color: var(--text-secondary);
    letter-spacing: 1px; text-transform: uppercase; transition: color 0.3s; text-align: center; white-space: nowrap; }
  .planet-desc { font-size: 8px; color: var(--text-dim); margin-top: 2px; text-align: center; max-width: 100px; }
  @keyframes pulse {
    0%, 100% { box-shadow: 0 0 20px var(--color), 0 0 60px color-mix(in srgb, var(--color) 30%, transparent); }
    50% { box-shadow: 0 0 30px var(--color), 0 0 80px color-mix(in srgb, var(--color) 40%, transparent); }
  }
  .galaxy-connections { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; pointer-events: none; }
  .galaxy-connections line { stroke: rgba(100, 140, 255, 0.06); stroke-width: 1; stroke-dasharray: 4 4; }
  .galaxy-stats {
    position: absolute; bottom: 8px; left: 50%; transform: translateX(-50%);
    display: flex; gap: 24px; z-index: 3; background: var(--bg-panel);
    border: 1px solid var(--border-glow); border-radius: 10px; padding: 10px 20px;
  }
  .stat-item { text-align: center; }
  .stat-value { font-size: 16px; font-weight: 700; color: var(--accent-cyan); }
  .stat-label { font-size: 8px; color: var(--text-dim); text-transform: uppercase; letter-spacing: 1px; margin-top: 2px; }

  /* Planet View */
  #planet-view { padding: 54px 40px 40px; align-items: flex-start; overflow-y: auto; }
  .planet-content { width: 100%; max-width: 1200px; margin: 0 auto; }
  .planet-header { display: flex; align-items: center; gap: 16px; margin-bottom: 20px; padding-bottom: 14px; border-bottom: 1px solid rgba(100,140,255,0.15); }
  .planet-header-orb { width: 44px; height: 44px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 22px; }
  .planet-header h2 { font-size: 20px; font-weight: 700; }
  .planet-header p { font-size: 11px; color: var(--text-secondary); line-height: 1.6; max-width: 700px; }
  .component-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 12px; margin-bottom: 20px; }
  .component-card {
    background: var(--bg-card); border: 1px solid rgba(100,140,255,0.12);
    border-radius: 10px; padding: 16px; cursor: pointer; transition: all 0.3s;
    position: relative; overflow: hidden;
  }
  .component-card:hover { border-color: var(--accent-blue); transform: translateY(-2px); box-shadow: 0 8px 30px rgba(77,139,255,0.15); }
  .component-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px; background: var(--card-accent, var(--accent-blue)); opacity: 0; transition: opacity 0.3s; }
  .component-card:hover::before { opacity: 1; }
  .component-card.highlight { border-color: var(--accent-cyan) !important; box-shadow: 0 0 20px rgba(0,212,255,0.2) !important; }
  .component-card h3 { font-size: 12px; font-weight: 600; margin-bottom: 5px; display: flex; align-items: center; gap: 8px; }
  .component-card h3 .icon { font-size: 15px; }
  .component-card .card-desc { font-size: 10px; color: var(--text-secondary); line-height: 1.5; margin-bottom: 8px; }
  .card-tags { display: flex; flex-wrap: wrap; gap: 3px; }
  .card-tag { font-size: 8px; padding: 2px 6px; border-radius: 3px; background: rgba(77,139,255,0.1); color: var(--accent-blue); border: 1px solid rgba(77,139,255,0.2); }
  .card-tag.obj { background: rgba(168,85,247,0.1); color: var(--accent-purple); border-color: rgba(168,85,247,0.2); }
  .card-tag.trigger { background: rgba(239,68,68,0.1); color: var(--accent-red); border-color: rgba(239,68,68,0.2); }
  .data-flow { background: var(--bg-card); border: 1px solid rgba(100,140,255,0.12); border-radius: 10px; padding: 16px; margin-bottom: 20px; }
  .data-flow h3 { font-size: 12px; font-weight: 600; margin-bottom: 10px; color: var(--accent-cyan); }
  .flow-diagram { display: flex; align-items: center; gap: 6px; flex-wrap: wrap; font-size: 10px; }
  .flow-node { background: rgba(77,139,255,0.1); border: 1px solid rgba(77,139,255,0.25); padding: 5px 10px; border-radius: 6px; white-space: nowrap; }
  .flow-arrow { color: var(--accent-cyan); font-size: 12px; }
  .connections-section { background: var(--bg-card); border: 1px solid rgba(100,140,255,0.12); border-radius: 10px; padding: 16px; margin-bottom: 20px; }
  .connections-section h3 { font-size: 12px; font-weight: 600; margin-bottom: 8px; color: var(--accent-purple); }
  .connection-item { display: flex; align-items: center; gap: 10px; padding: 6px 0; border-bottom: 1px solid rgba(100,140,255,0.06); font-size: 10px; cursor: pointer; transition: color 0.2s; }
  .connection-item:hover { color: var(--accent-cyan); }
  .connection-item:last-child { border-bottom: none; }
  .conn-planet { width: 22px; height: 22px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 11px; }

  /* Core View */
  #core-view { padding: 54px 40px 40px; align-items: flex-start; overflow-y: auto; }
  .core-content { width: 100%; max-width: 1100px; margin: 0 auto; }
  .core-header { display: flex; align-items: center; gap: 12px; margin-bottom: 16px; padding-bottom: 12px; border-bottom: 1px solid rgba(239,68,68,0.2); }
  .core-header h2 { font-size: 18px; font-weight: 700; }
  .core-header .badge { font-size: 9px; padding: 3px 8px; border-radius: 4px; background: rgba(239,68,68,0.15); color: var(--accent-red); text-transform: uppercase; letter-spacing: 1px; }
  .trigger-section { background: var(--bg-card); border: 1px solid rgba(100,140,255,0.12); border-radius: 10px; padding: 16px; margin-bottom: 14px; }
  .trigger-section h3 { font-size: 12px; font-weight: 600; margin-bottom: 4px; }
  .trigger-section .trigger-desc { font-size: 10px; color: var(--text-secondary); line-height: 1.5; margin-bottom: 12px; }
  .execution-flow { display: flex; flex-direction: column; gap: 3px; margin-bottom: 12px; }
  .exec-step { display: flex; align-items: center; gap: 8px; font-size: 10px; padding: 4px 10px; background: rgba(77,139,255,0.05); border-radius: 4px; border-left: 2px solid var(--accent-blue); }
  .exec-step .step-num { color: var(--accent-cyan); font-weight: 700; min-width: 18px; }
  .code-block { background: #0d1117; border: 1px solid rgba(100,140,255,0.15); border-radius: 8px; overflow: hidden; margin-top: 8px; }
  .code-header { display: flex; align-items: center; justify-content: space-between; padding: 5px 14px; background: rgba(100,140,255,0.06); border-bottom: 1px solid rgba(100,140,255,0.1); font-size: 10px; color: var(--text-dim); }
  .code-header .lang { color: var(--accent-orange); font-weight: 600; }
  .code-header .copy-btn { background: none; border: 1px solid rgba(100,140,255,0.2); color: var(--text-dim); font-size: 9px; padding: 2px 8px; border-radius: 3px; cursor: pointer; font-family: inherit; transition: all 0.2s; }
  .code-header .copy-btn:hover { border-color: var(--accent-blue); color: var(--accent-blue); }
  .code-body { padding: 12px; overflow-x: auto; font-size: 10px; line-height: 1.6; tab-size: 2; }
  .code-body pre { font-family: 'SF Mono', 'Fira Code', monospace; white-space: pre; }
  .kw { color: #ff7b72; } .ty { color: #79c0ff; } .fn { color: #d2a8ff; }
  .st { color: #a5d6ff; } .cm { color: #8b949e; } .nu { color: #79c0ff; }
  .an { color: #ffa657; } .op { color: #ff7b72; } .var { color: #ffa657; }
  .code-lab { background: var(--bg-card); border: 1px solid rgba(34,197,94,0.2); border-radius: 10px; padding: 16px; margin-top: 20px; margin-bottom: 40px; }
  .code-lab h3 { font-size: 12px; font-weight: 600; color: var(--accent-green); margin-bottom: 4px; }
  .code-lab .lab-desc { font-size: 10px; color: var(--text-secondary); margin-bottom: 12px; }
  .lab-tabs { display: flex; gap: 4px; margin-bottom: 8px; }
  .lab-tab { font-size: 9px; padding: 4px 10px; border-radius: 4px; background: rgba(34,197,94,0.05); border: 1px solid rgba(34,197,94,0.15); color: var(--text-secondary); cursor: pointer; font-family: inherit; transition: all 0.2s; }
  .lab-tab.active, .lab-tab:hover { background: rgba(34,197,94,0.15); color: var(--accent-green); border-color: rgba(34,197,94,0.3); }
  .back-btn {
    position: fixed; top: 50px; left: 20px; z-index: 50;
    background: var(--bg-panel); border: 1px solid var(--border-glow);
    color: var(--text-secondary); font-size: 10px; padding: 5px 12px;
    border-radius: 6px; cursor: pointer; font-family: inherit;
    display: none; align-items: center; gap: 6px; transition: all 0.2s; backdrop-filter: blur(8px);
  }
  .back-btn:hover { border-color: var(--accent-blue); color: var(--accent-blue); }
  .back-btn.visible { display: flex; }
  .help-hint {
    position: fixed; bottom: 12px; right: 12px; z-index: 50;
    font-size: 9px; color: var(--text-dim); background: var(--bg-panel);
    padding: 5px 10px; border-radius: 6px; border: 1px solid rgba(100,140,255,0.1);
  }
  .help-hint kbd { background: rgba(100,140,255,0.1); padding: 2px 5px; border-radius: 3px; font-family: inherit; border: 1px solid rgba(100,140,255,0.2); }
  ::-webkit-scrollbar { width: 5px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: rgba(100,140,255,0.2); border-radius: 3px; }
  ::-webkit-scrollbar-thumb:hover { background: rgba(100,140,255,0.4); }
  @media (max-width: 900px) {
    #galaxy-map { width: 100%; height: auto; min-height: 700px; }
    .galaxy-stats { flex-wrap: wrap; gap: 12px; }
    .component-grid { grid-template-columns: 1fr; }
    .search-container { width: 95vw; }
  }
</style>
</head>
<body>
<canvas id="starfield"></canvas>

<!-- Search Overlay -->
<div id="search-overlay">
  <div class="search-container">
    <div class="search-input-wrap">
      <span class="search-icon">&#x1F50D;</span>
      <input type="text" id="searchInput" placeholder="Search triggers, classes, objects, concepts..." autocomplete="off" spellcheck="false">
      <div class="search-nav" id="searchNav" style="display:none">
        <span class="search-count" id="searchCount">0/0</span>
        <button class="search-nav-btn" onclick="cycleResult(-1)" title="Previous (Shift+Enter)">&#x25B2;</button>
        <button class="search-nav-btn" onclick="cycleResult(1)" title="Next (Enter)">&#x25BC;</button>
      </div>
      <button class="search-close" onclick="closeSearch()">ESC</button>
    </div>
    <div class="search-results" id="searchResults"></div>
    <div class="search-hint">
      <kbd>Enter</kbd> next result &middot; <kbd>Shift+Enter</kbd> previous &middot; <kbd>ESC</kbd> close &middot; Click to navigate
    </div>
  </div>
</div>

<nav id="navbar">
  <div class="logo">NPSP <span>GALAXY EXPLORER</span></div>
  <div id="breadcrumb">
    <span class="crumb active" data-level="galaxy">Galaxy</span>
  </div>
  <div style="display:flex;align-items:center;gap:16px">
    <button onclick="openSearch()" style="background:rgba(100,140,255,0.08);border:1px solid rgba(100,140,255,0.2);color:var(--text-dim);font-size:10px;padding:4px 12px;border-radius:6px;cursor:pointer;font-family:inherit;display:flex;align-items:center;gap:6px;transition:all 0.2s" onmouseover="this.style.borderColor='var(--accent-blue)';this.style.color='var(--accent-blue)'" onmouseout="this.style.borderColor='rgba(100,140,255,0.2)';this.style.color='var(--text-dim)'">
      &#x1F50D; <span>Search</span> <kbd style="background:rgba(100,140,255,0.1);padding:1px 4px;border-radius:3px;font-size:8px;border:1px solid rgba(100,140,255,0.2);margin-left:4px">/</kbd>
    </button>
    <div id="zoom-indicator">
      <span style="font-size:9px;margin-right:4px">ZOOM</span>
      <div class="zoom-dot active" data-z="1"></div>
      <div class="zoom-dot" data-z="2"></div>
      <div class="zoom-dot" data-z="3"></div>
    </div>
  </div>
</nav>

<button class="back-btn" id="backBtn" onclick="goBack()"><span>&larr;</span> Back</button>

<div id="stage">
  <!-- GALAXY VIEW -->
  <div id="galaxy-view" class="view-layer active">
    <div class="galaxy-title">
      <h1>NONPROFIT SUCCESS PACK</h1>
      <p>The most widely adopted nonprofit technology on Salesforce. 843 Apex classes, 26 triggers, 65 custom objects. NPSP transforms Salesforce into a purpose-built nonprofit CRM for donations, constituent management, recurring giving, and fundraising analytics.</p>
      <div class="galaxy-subtitle">CLICK A PLANET TO EXPLORE &middot; PRESS / TO SEARCH &middot; 16 FEATURE DOMAINS</div>
    </div>
    <div id="galaxy-map">
      <svg class="galaxy-connections" viewBox="0 0 1100 600">
        <!-- Core connections -->
        <line x1="500" y1="60" x2="200" y2="130"/><line x1="500" y1="60" x2="800" y2="100"/>
        <line x1="500" y1="60" x2="500" y2="190"/><line x1="200" y1="130" x2="80" y2="260"/>
        <line x1="800" y1="100" x2="920" y2="230"/><line x1="500" y1="190" x2="320" y2="280"/>
        <line x1="500" y1="190" x2="680" y2="250"/><line x1="80" y1="260" x2="180" y2="390"/>
        <line x1="920" y1="230" x2="820" y2="370"/><line x1="320" y1="280" x2="180" y2="390"/>
        <line x1="680" y1="250" x2="820" y2="370"/><line x1="180" y1="390" x2="400" y2="450"/>
        <line x1="820" y1="370" x2="600" y2="450"/><line x1="400" y1="450" x2="600" y2="450"/>
        <line x1="500" y1="530" x2="400" y2="450"/><line x1="500" y1="530" x2="600" y2="450"/>
        <line x1="320" y1="280" x2="680" y2="250"/>
      </svg>

      <!-- Row 1: Core giving -->
      <div class="planet" data-planet="donations" style="left:455px;top:10px;--size:62px;--color:#4d8bff;--delay:0s" onclick="enterPlanet('donations')">
        <div class="planet-orb" style="background:radial-gradient(circle at 35% 35%,#7db3ff,#4d8bff,#2563eb)">&#x1F4B0;</div>
        <div class="planet-ring"></div><div class="planet-label">Donations</div><div class="planet-desc">Core giving</div>
      </div>
      <div class="planet" data-planet="contacts" style="left:155px;top:80px;--size:58px;--color:#a855f7;--delay:0.5s" onclick="enterPlanet('contacts')">
        <div class="planet-orb" style="background:radial-gradient(circle at 35% 35%,#c084fc,#a855f7,#7c3aed)">&#x1F465;</div>
        <div class="planet-ring"></div><div class="planet-label">Contacts</div><div class="planet-desc">Households</div>
      </div>
      <div class="planet" data-planet="recurring" style="left:755px;top:50px;--size:54px;--color:#22c55e;--delay:1s" onclick="enterPlanet('recurring')">
        <div class="planet-orb" style="background:radial-gradient(circle at 35% 35%,#4ade80,#22c55e,#16a34a)">&#x1F504;</div>
        <div class="planet-ring"></div><div class="planet-label">Recurring</div><div class="planet-desc">89 classes</div>
      </div>

      <!-- Row 2: Data processing -->
      <div class="planet" data-planet="rollups" style="left:455px;top:145px;--size:58px;--color:#f59e0b;--delay:0.3s" onclick="enterPlanet('rollups')">
        <div class="planet-orb" style="background:radial-gradient(circle at 35% 35%,#fbbf24,#f59e0b,#d97706)">&#x1F4CA;</div>
        <div class="planet-ring"></div><div class="planet-label">Rollups (CRLP)</div><div class="planet-desc">76 classes</div>
      </div>
      <div class="planet" data-planet="softcredits" style="left:40px;top:210px;--size:44px;--color:#ec4899;--delay:0.7s" onclick="enterPlanet('softcredits')">
        <div class="planet-orb" style="background:radial-gradient(circle at 35% 35%,#f472b6,#ec4899,#db2777)">&#x1F91D;</div>
        <div class="planet-ring"></div><div class="planet-label">Soft Credits</div><div class="planet-desc">Attribution</div>
      </div>
      <div class="planet" data-planet="allocations" style="left:880px;top:180px;--size:46px;--color:#06b6d4;--delay:1.2s" onclick="enterPlanet('allocations')">
        <div class="planet-orb" style="background:radial-gradient(circle at 35% 35%,#22d3ee,#06b6d4,#0891b2)">&#x1F4C2;</div>
        <div class="planet-ring"></div><div class="planet-label">Allocations</div><div class="planet-desc">Fund acct</div>
      </div>

      <!-- Row 3: Architecture & management -->
      <div class="planet" data-planet="tdtm" style="left:275px;top:230px;--size:50px;--color:#ef4444;--delay:0.9s" onclick="enterPlanet('tdtm')">
        <div class="planet-orb" style="background:radial-gradient(circle at 35% 35%,#f87171,#ef4444,#dc2626)">&#x26A1;</div>
        <div class="planet-ring"></div><div class="planet-label">TDTM</div><div class="planet-desc">Trigger arch</div>
      </div>
      <div class="planet" data-planet="batch" style="left:635px;top:200px;--size:46px;--color:#8b5cf6;--delay:1.5s" onclick="enterPlanet('batch')">
        <div class="planet-orb" style="background:radial-gradient(circle at 35% 35%,#a78bfa,#8b5cf6,#7c3aed)">&#x2699;</div>
        <div class="planet-ring"></div><div class="planet-label">Batch Jobs</div><div class="planet-desc">45 classes</div>
      </div>

      <!-- Row 4: Relationships, Addresses, Affiliations -->
      <div class="planet" data-planet="relationships" style="left:135px;top:340px;--size:42px;--color:#f43f5e;--delay:1.1s" onclick="enterPlanet('relationships')">
        <div class="planet-orb" style="background:radial-gradient(circle at 35% 35%,#fb7185,#f43f5e,#e11d48)">&#x1F517;</div>
        <div class="planet-ring"></div><div class="planet-label">Relationships</div><div class="planet-desc">Reciprocal</div>
      </div>
      <div class="planet" data-planet="addresses" style="left:320px;top:360px;--size:40px;--color:#14b8a6;--delay:1.3s" onclick="enterPlanet('addresses')">
        <div class="planet-orb" style="background:radial-gradient(circle at 35% 35%,#2dd4bf,#14b8a6,#0d9488)">&#x1F4CD;</div>
        <div class="planet-ring"></div><div class="planet-label">Addresses</div><div class="planet-desc">20 classes</div>
      </div>
      <div class="planet" data-planet="affiliations" style="left:780px;top:320px;--size:40px;--color:#6366f1;--delay:1.4s" onclick="enterPlanet('affiliations')">
        <div class="planet-orb" style="background:radial-gradient(circle at 35% 35%,#818cf8,#6366f1,#4f46e5)">&#x1F3E2;</div>
        <div class="planet-ring"></div><div class="planet-label">Affiliations</div><div class="planet-desc">Org links</div>
      </div>

      <!-- Row 5: Engagement, BDI, Gift Entry, Levels -->
      <div class="planet" data-planet="engagement" style="left:50px;top:440px;--size:42px;--color:#84cc16;--delay:1.6s" onclick="enterPlanet('engagement')">
        <div class="planet-orb" style="background:radial-gradient(circle at 35% 35%,#a3e635,#84cc16,#65a30d)">&#x1F4CB;</div>
        <div class="planet-ring"></div><div class="planet-label">Engagement</div><div class="planet-desc">Plans</div>
      </div>
      <div class="planet" data-planet="bdi" style="left:355px;top:410px;--size:48px;--color:#d97706;--delay:1.7s" onclick="enterPlanet('bdi')">
        <div class="planet-orb" style="background:radial-gradient(circle at 35% 35%,#fbbf24,#d97706,#b45309)">&#x1F4E5;</div>
        <div class="planet-ring"></div><div class="planet-label">BDI</div><div class="planet-desc">66 classes</div>
      </div>
      <div class="planet" data-planet="giftentry" style="left:555px;top:410px;--size:46px;--color:#0ea5e9;--delay:1.8s" onclick="enterPlanet('giftentry')">
        <div class="planet-orb" style="background:radial-gradient(circle at 35% 35%,#38bdf8,#0ea5e9,#0284c7)">&#x1F381;</div>
        <div class="planet-ring"></div><div class="planet-label">Gift Entry</div><div class="planet-desc">Modern UI</div>
      </div>
      <div class="planet" data-planet="levels" style="left:900px;top:420px;--size:38px;--color:#10b981;--delay:1.9s" onclick="enterPlanet('levels')">
        <div class="planet-orb" style="background:radial-gradient(circle at 35% 35%,#34d399,#10b981,#059669)">&#x1F3C6;</div>
        <div class="planet-ring"></div><div class="planet-label">Levels</div><div class="planet-desc">Donor tiers</div>
      </div>

      <!-- Row 6: Error handling, Settings, Elevate -->
      <div class="planet" data-planet="errors" style="left:220px;top:500px;--size:38px;--color:#d946ef;--delay:2.0s" onclick="enterPlanet('errors')">
        <div class="planet-orb" style="background:radial-gradient(circle at 35% 35%,#e879f9,#d946ef,#c026d3)">&#x26A0;</div>
        <div class="planet-ring"></div><div class="planet-label">Errors</div><div class="planet-desc">22 classes</div>
      </div>
      <div class="planet" data-planet="settings" style="left:455px;top:490px;--size:40px;--color:#64748b;--delay:2.1s" onclick="enterPlanet('settings')">
        <div class="planet-orb" style="background:radial-gradient(circle at 35% 35%,#94a3b8,#64748b,#475569)">&#x2699;</div>
        <div class="planet-ring"></div><div class="planet-label">Settings</div><div class="planet-desc">14+ objects</div>
      </div>
      <div class="planet" data-planet="elevate" style="left:700px;top:490px;--size:38px;--color:#7c3aed;--delay:2.2s" onclick="enterPlanet('elevate')">
        <div class="planet-orb" style="background:radial-gradient(circle at 35% 35%,#a78bfa,#7c3aed,#6d28d9)">&#x1F4B3;</div>
        <div class="planet-ring"></div><div class="planet-label">Elevate</div><div class="planet-desc">Payments</div>
      </div>
    </div>
    <div class="galaxy-stats">
      <div class="stat-item"><div class="stat-value">843</div><div class="stat-label">Apex Classes</div></div>
      <div class="stat-item"><div class="stat-value">26</div><div class="stat-label">Triggers</div></div>
      <div class="stat-item"><div class="stat-value">65</div><div class="stat-label">Custom Objects</div></div>
      <div class="stat-item"><div class="stat-value">45</div><div class="stat-label">Batch Jobs</div></div>
      <div class="stat-item"><div class="stat-value">100+</div><div class="stat-label">LWC Components</div></div>
      <div class="stat-item"><div class="stat-value">16</div><div class="stat-label">Domains</div></div>
    </div>
  </div>

  <!-- PLANET VIEW -->
  <div id="planet-view" class="view-layer">
    <div class="planet-content" id="planet-content"></div>
  </div>

  <!-- CORE VIEW -->
  <div id="core-view" class="view-layer">
    <div class="core-content" id="core-content"></div>
  </div>
</div>

<div class="help-hint">
  <kbd>/</kbd> search &middot; <kbd>ESC</kbd> zoom out &middot; Click planets to explore
</div>

<script>
// ══════════════════════════════════════════════════════════════
//  NPSP KNOWLEDGE BASE — 16 Feature Domains, 843 classes
// ══════════════════════════════════════════════════════════════
const NPSP = {

donations: {
  name: "Donations & Payments",
  icon: "\u{1F4B0}",
  color: "#4d8bff",
  description: "The heart of NPSP. Donations are Salesforce Opportunities with specialized nonprofit behavior. NPSP adds payment tracking via npe01__OppPayment__c, soft credits, matching gifts, tributes, and automatic rollup calculations. PMT_Payment_TDTM handles payment creation and sync, while OPP_OpportunityNaming generates names from configurable patterns.",
  components: [
    {id:"opp-naming",name:"Opportunity Naming",icon:"\u{1F3F7}",desc:"Auto-names donations using configurable patterns from donor, amount, date, record type, and campaign fields. OPP_OpportunityNaming handler runs before insert/update. OPP_OpportunityNaming_BATCH handles bulk renaming.",tags:["OPP_OpportunityNaming","OPP_OpportunityNaming_BATCH"],triggerTags:["before insert","before update"],code:{title:"OPP_OpportunityNaming.cls",lang:"Apex",body:'<span class="cm">// TDTM Handler: Automatic Opportunity Naming</span>\n<span class="kw">public class</span> <span class="ty">OPP_OpportunityNaming</span> <span class="kw">extends</span> <span class="ty">TDTM_Runnable</span> {\n\n  <span class="kw">public override</span> <span class="ty">DmlWrapper</span> <span class="fn">run</span>(\n    <span class="ty">List&lt;SObject&gt;</span> newList,\n    <span class="ty">List&lt;SObject&gt;</span> oldList,\n    <span class="ty">TDTM_Runnable.Action</span> triggerAction,\n    <span class="ty">Schema.DescribeSObjectResult</span> objResult\n  ) {\n    <span class="kw">for</span> (<span class="ty">Opportunity</span> opp : (<span class="ty">List&lt;Opportunity&gt;</span>)newList) {\n      <span class="kw">if</span> (shouldRename(opp, oldMap)) {\n        opp.Name = <span class="fn">constructName</span>(opp);\n      }\n    }\n    <span class="kw">return null</span>; <span class="cm">// before trigger, no DML needed</span>\n  }\n}'},executionFlow:["User creates/updates Opportunity","TDTM dispatcher fires OPP_OpportunityNaming (before)","Handler checks naming settings via UTIL_CustomSettingsFacade","Constructs name from configured pattern tokens","Sets Opportunity.Name before DML completes"]},
    {id:"payments",name:"Payment Processing",icon:"\u{1F4B3}",desc:"Auto-creates npe01__OppPayment__c records when Opportunities are created. PMT_Payment_TDTM handles creation, sync, currency validation, and accounting data consistency enforcement. Supports writeoff, refunds, and multi-payment splitting.",tags:["PMT_Payment_TDTM","PMT_PaymentCreator","npe01__OppPayment__c"],triggerTags:["after insert","after update"],code:{title:"PMT_Payment_TDTM.cls",lang:"Apex",body:'<span class="cm">// Payment handler with settings facade pattern</span>\n<span class="kw">public class</span> <span class="ty">PMT_Payment_TDTM</span> <span class="kw">extends</span> <span class="ty">TDTM_Runnable</span> {\n\n  <span class="kw">private static final</span> <span class="ty">npo02__Households_Settings__c</span>\n    householdSettings =\n    <span class="ty">UTIL_CustomSettingsFacade</span>.<span class="fn">getHouseholdsSettings</span>();\n\n  <span class="kw">private</span> <span class="ty">Boolean</span> isEnforceAccountingDataConsistency {\n    <span class="kw">get</span> {\n      <span class="kw">if</span> (isEnforceAccountingDataConsistency == <span class="kw">null</span>) {\n        isEnforceAccountingDataConsistency =\n          <span class="ty">UTIL_CustomSettingsFacade</span>.<span class="fn">getContactsSettings</span>()\n            .Enforce_Accounting_Data_Consistency__c;\n      }\n      <span class="kw">return</span> isEnforceAccountingDataConsistency;\n    }\n    <span class="kw">set</span>;\n  }\n\n  <span class="kw">public override</span> <span class="ty">DmlWrapper</span> <span class="fn">run</span>(...) {\n    <span class="cm">// Payment creation, sync, and validation</span>\n  }\n}'},executionFlow:["Opportunity created with Amount > 0","TDTM fires PMT_Payment_TDTM (after insert)","Handler reads settings via UTIL_CustomSettingsFacade","Creates npe01__OppPayment__c linked to Opportunity","Enforces accounting data consistency if configured","Payment Amount, Date, and Paid status set automatically"]},
    {id:"donor-stats",name:"Donor Statistics",icon:"\u{1F4C8}",desc:"Tracks giving history on Contact/Account: total gifts, largest gift, first/last gift date, giving level, consecutive years, donor streaks. Updated by CRLP rollup engine after every donation change. Fields include npo02__TotalOppAmount__c, npo02__NumberOfClosedOpps__c, npo02__Best_Gift_Year__c.",tags:["CRLP_RollupProcessor","Contact","Account"],triggerTags:["batch rollup"],code:{title:"Donor Statistics Fields",lang:"Apex",body:'<span class="cm">// Key rollup fields on Contact/Account</span>\n<span class="cm">// Automatically maintained by CRLP engine</span>\n\n<span class="ty">Contact</span> donor = [\n  <span class="kw">SELECT</span>\n    npo02__TotalOppAmount__c,        <span class="cm">// Lifetime giving</span>\n    npo02__NumberOfClosedOpps__c,     <span class="cm">// Total count</span>\n    npo02__FirstCloseDate__c,         <span class="cm">// First gift</span>\n    npo02__LastCloseDate__c,          <span class="cm">// Most recent</span>\n    npo02__LargestAmount__c,          <span class="cm">// Largest gift</span>\n    npo02__SmallestAmount__c,         <span class="cm">// Smallest gift</span>\n    npo02__AverageAmount__c,          <span class="cm">// Average gift</span>\n    npo02__Best_Gift_Year__c,         <span class="cm">// Best year</span>\n    npo02__Best_Gift_Year_Total__c    <span class="cm">// Best year $</span>\n  <span class="kw">FROM</span> <span class="ty">Contact</span>\n  <span class="kw">WHERE</span> Id = :donorId\n];'},executionFlow:["Donation created/updated/deleted","CRLP batch or trigger picks up changed records","Calculates SUM, COUNT, MIN, MAX, AVG, FIRST, LAST","Applies fiscal year and filter criteria","Updates rollup fields on parent Contact/Account"]},
    {id:"matching-gifts",name:"Matching Gifts",icon:"\u{1F91D}",desc:"Tracks corporate matching gift programs. MTCH_Opportunity_TDTM links a donation to a matching gift Opportunity. Supports partial match ratios and status tracking. Employment affiliations identify matching gift eligibility.",tags:["MTCH_Opportunity_TDTM","Matching_Gift__c"],triggerTags:["after update"]},
    {id:"contact-roles",name:"Contact Roles",icon:"\u{1F465}",desc:"OPP_OpportunityContactRoles_TDTM and HH_OppContactRoles_TDTM manage primary and soft credit contact roles. Auto-creates OCRs for household members, enabling soft credit attribution.",tags:["OPP_OpportunityContactRoles_TDTM","HH_OppContactRoles_TDTM","OpportunityContactRole"],triggerTags:["after insert","after update"]},
    {id:"cascade-delete",name:"Cascade Deletes",icon:"\u{1F5D1}",desc:"OPP_CascadeDeleteLookups_TDTM and PMT_CascadeDeleteLookups_TDTM implement soft cascade deletes through lookup relationships. Prevents orphaned payment records when Opportunities are deleted.",tags:["OPP_CascadeDeleteLookups_TDTM","PMT_CascadeDeleteLookups_TDTM"],triggerTags:["before delete","after delete","after undelete"]}
  ],
  dataFlow:["Donor (Contact)","Opportunity","Payment","Allocation","Rollup to Contact/Account"],
  connections:[{planet:"contacts",desc:"Donor Contact/Account provides the giving entity"},{planet:"rollups",desc:"Every donation change triggers CRLP rollup recalculation"},{planet:"allocations",desc:"Donation amount distributed across GAUs"},{planet:"softcredits",desc:"Soft credits attribute donations to additional contacts"},{planet:"recurring",desc:"Recurring Donations auto-create Opportunity records"},{planet:"giftentry",desc:"Gift Entry UI creates donations through BDI"}]
},

contacts: {
  name: "Contacts & Households",
  icon: "\u{1F465}",
  color: "#a855f7",
  description: "NPSP reimagines the Salesforce Account-Contact model for nonprofits. The Household Account model groups family members under a shared Account. ACCT_IndividualAccounts_TDTM is the most heavily loaded handler, firing on nearly all Contact trigger events. HH_HouseholdNaming auto-generates household names and greetings. Also supports 1:1 individual model and Organization accounts. 18 HH_ classes, 16 CON_ classes, 5 ACCT_ classes.",
  components: [
    {id:"household-model",name:"Household Account Model",icon:"\u{1F3E0}",desc:"Default NPSP model. Each household gets an Account record. ACCT_IndividualAccounts_TDTM creates/manages Household Accounts on Contact insert/update/delete. Fires on BeforeInsert, BeforeUpdate, AfterInsert, AfterUpdate, AfterDelete, AfterUndelete.",tags:["ACCT_IndividualAccounts_TDTM","Account","Contact"],triggerTags:["before insert","after insert","after update","after delete"],code:{title:"ACCT_IndividualAccounts_TDTM Registration",lang:"Apex",body:'<span class="cm">// The most heavily loaded handler in NPSP</span>\n<span class="cm">// Registered on Contact with 6 trigger actions</span>\nhandlers.add(<span class="kw">new</span> <span class="ty">Trigger_Handler__c</span>(\n  Active__c = <span class="kw">true</span>,\n  Class__c = <span class="st">\'ACCT_IndividualAccounts_TDTM\'</span>,\n  Load_Order__c = <span class="nu">1</span>,\n  Object__c = <span class="st">\'Contact\'</span>,\n  Trigger_Action__c = <span class="st">\'BeforeInsert;BeforeUpdate;\'</span>\n    + <span class="st">\'AfterInsert;AfterUpdate;\'</span>\n    + <span class="st">\'AfterDelete;AfterUndelete\'</span>\n));\n\n<span class="cm">// This handler:</span>\n<span class="cm">// - Creates Household Account when Contact has none</span>\n<span class="cm">// - Moves Contact between households on reparenting</span>\n<span class="cm">// - Updates household naming when contacts change</span>\n<span class="cm">// - Handles contact deletion cleanup</span>'},executionFlow:["Contact created without Account","ACCT_IndividualAccounts_TDTM fires (AfterInsert)","Creates new Household Account","Links Contact to Household Account","HH_HouseholdNaming generates name and greetings","Address management syncs household address"]},
    {id:"hh-naming",name:"Household Naming",icon:"\u{1F4DD}",desc:"HH_HouseholdNaming constructs names, formal greetings, and informal greetings from household members. Configurable via Household_Naming_Settings__c. HH_HouseholdNaming_BATCH handles bulk recalculation.",tags:["HH_HouseholdNaming","HH_HouseholdNaming_BATCH","Household_Naming_Settings__c"],triggerTags:["after insert","after update"],code:{title:"HH_HouseholdNaming.cls",lang:"Apex",body:'<span class="cm">// Household naming logic</span>\n<span class="kw">public class</span> <span class="ty">HH_HouseholdNaming</span> {\n\n  <span class="kw">public static</span> <span class="ty">String</span> <span class="fn">getHouseholdName</span>(\n    <span class="ty">List&lt;Contact&gt;</span> members\n  ) {\n    <span class="ty">List&lt;String&gt;</span> lastNames = <span class="kw">new</span> <span class="ty">List&lt;String&gt;</span>();\n    <span class="kw">for</span> (<span class="ty">Contact</span> c : members) {\n      <span class="kw">if</span> (!lastNames.contains(c.LastName))\n        lastNames.add(c.LastName);\n    }\n    <span class="cm">// "Smith Household" or "Smith & Jones Household"</span>\n    <span class="kw">return</span> <span class="ty">String</span>.join(lastNames, <span class="st">\' & \'</span>)\n      + <span class="st">\' Household\'</span>;\n  }\n}'},executionFlow:["Contact created/updated with household fields","HH_Households_TDTM fires (AfterInsert/AfterUpdate)","Queries all members of the household Account","HH_HouseholdNaming constructs name from members","Sets Account.Name, Formal_Greeting__c, Informal_Greeting__c"]},
    {id:"contact-merge",name:"Contact Merge",icon:"\u{1F500}",desc:"CON_ContactMerge_TDTM preserves relationships, affiliations, and address records during contact merge. Also handles Do Not Contact automation via CON_DoNotContact_TDTM.",tags:["CON_ContactMerge_TDTM","CON_DoNotContact_TDTM"],triggerTags:["after update","after delete"]},
    {id:"acct-merge",name:"Account Merge",icon:"\u{1F3E2}",desc:"ACCT_AccountMerge_TDTM and ACCT_Accounts_TDTM handle post-merge cleanup for Accounts, reassigning child records and recalculating rollups.",tags:["ACCT_AccountMerge_TDTM","ACCT_Accounts_TDTM"],triggerTags:["after update","after delete"]}
  ],
  dataFlow:["Contact","Household Account","Address__c","Relationship__c","Affiliation__c"],
  connections:[{planet:"donations",desc:"Contacts/Accounts are the donors on Opportunities"},{planet:"rollups",desc:"Giving totals roll up to Contact and Account records"},{planet:"relationships",desc:"Contact-to-contact relationships tracked"},{planet:"affiliations",desc:"Contact-to-organization links"},{planet:"addresses",desc:"Household addresses shared by all members"}]
},

recurring: {
  name: "Recurring Donations (RD2)",
  icon: "\u{1F504}",
  color: "#22c55e",
  description: "Enhanced Recurring Donations v2 is one of NPSP's most complex subsystems with 89 Apex classes. Manages scheduled recurring gifts with configurable frequencies, pause/resume, status automation, change logging, and Elevate payment integration. Auto-generates Opportunity records on schedule via RD2_OpportunityService. Legacy RD_ classes (13) remain for backward compatibility.",
  components: [
    {id:"rd2-engine",name:"RD2 Installment Engine",icon:"\u{1F4C5}",desc:"RD2_ScheduleService manages installment schedules and date calculations. RD2_OpportunityService creates/updates Opportunities. RD2_OpportunityMatcher matches existing Opportunities to installments to avoid duplicates.",tags:["RD2_RecurringDonations_TDTM","RD2_ScheduleService","RD2_OpportunityService"],triggerTags:["after insert","after update"],code:{title:"RD2_RecurringDonations_TDTM.cls",lang:"Apex",body:'<span class="cm">// Enhanced RD handler with service injection</span>\n<span class="kw">public class</span> <span class="ty">RD2_RecurringDonations_TDTM</span>\n  <span class="kw">extends</span> <span class="ty">TDTM_Runnable</span> {\n\n  <span class="kw">private</span> <span class="ty">DmlWrapper</span> dmlActions =\n    <span class="kw">new</span> <span class="ty">DmlWrapper</span>();\n\n  <span class="an">@TestVisible</span>\n  <span class="kw">private</span> <span class="ty">RD2_ScheduleService</span> scheduleService {\n    <span class="kw">get</span> {\n      <span class="kw">if</span> (scheduleService == <span class="kw">null</span>) {\n        scheduleService =\n          <span class="kw">new</span> <span class="ty">RD2_ScheduleService</span>();\n      }\n      <span class="kw">return</span> scheduleService;\n    }\n    <span class="kw">set</span>;\n  }\n\n  <span class="kw">public override</span> <span class="ty">DmlWrapper</span> <span class="fn">run</span>(...) {\n    <span class="cm">// Validates, builds schedules,</span>\n    <span class="cm">// evaluates opportunities</span>\n  }\n}'},executionFlow:["Recurring Donation created or modified","TDTM fires RD2_RecurringDonations_TDTM (after)","RD2_ScheduleService calculates next installment dates","RD2_OpportunityService creates Opportunity records","RD2_OpportunityMatcher checks for existing matches","Links each Opportunity back to the RD record"]},
    {id:"rd2-status",name:"Status Automation",icon:"\u{1F6A6}",desc:"RD2_StatusAutomationService tracks lifecycle: Active, Lapsed, Closed, Paused. Automatically transitions based on payment history and configurable grace periods. Status mapping via RecurringDonationStatusMapping__mdt.",tags:["RD2_StatusAutomationService","RecurringDonationStatusMapping__mdt"],triggerTags:["after update"]},
    {id:"rd2-schedule",name:"Schedule & Change Log",icon:"\u{1F5D3}",desc:"RecurringDonationSchedule__c stores schedule entries (pause periods, amount changes). RecurringDonationChangeLog__c tracks all modifications. LWC components: rd2EntryForm, rd2PauseForm, rd2ChangeLog, rdScheduleVisualizer.",tags:["RecurringDonationSchedule__c","RecurringDonationChangeLog__c"],triggerTags:["after insert"]},
    {id:"rd2-batch",name:"RD Evaluation Batch",icon:"\u{2699}",desc:"RD2_OpportunityEvaluation_BATCH processes all active RDs nightly, creating new installments and updating statuses. RD2_DataMigration_BATCH migrates from legacy to enhanced RDs.",tags:["RD2_OpportunityEvaluation_BATCH","RD2_DataMigration_BATCH"],triggerTags:["nightly batch"]},
    {id:"rd2-elevate",name:"Elevate Integration",icon:"\u{1F4B3}",desc:"RD2_ElevateIntegrationService handles recurring payment processing through Salesforce Elevate. Manages commitment requests, payment capture, and tokenized card storage.",tags:["RD2_ElevateIntegrationService","PS_CommitmentRequest"],triggerTags:["callout"]}
  ],
  dataFlow:["Recurring_Donation__c","RD_Schedule__c","ChangeLog__c","Opportunity (auto)","Payment","Rollup"],
  connections:[{planet:"donations",desc:"RDs auto-create Opportunity records as installments"},{planet:"contacts",desc:"Each RD linked to a donor Contact/Account"},{planet:"rollups",desc:"Current/Next Year values roll up from installments"},{planet:"batch",desc:"RD2_OpportunityEvaluation_BATCH processes bulk updates"},{planet:"elevate",desc:"Elevate handles recurring payment processing"},{planet:"allocations",desc:"RD allocations propagate to generated Opportunities"}]
},

rollups: {
  name: "Customizable Rollups (CRLP)",
  icon: "\u{1F4CA}",
  color: "#f59e0b",
  description: "NPSP's most architecturally sophisticated subsystem: 76 Apex classes. Replaces legacy hardcoded rollups (RLLP_) with a metadata-driven engine. Rollup definitions in Rollup__mdt, filtering via Filter_Group__mdt + Filter_Rule__mdt. Supports SUM, COUNT, AVG, FIRST, LAST, YEARS_DONATED, DONOR_STREAK. Operates in two modes: NonSkew (query summary records) for normal volumes and SkewMode (query detail records) for accounts with many children.",
  components: [
    {id:"crlp-processor",name:"CRLP Processor",icon:"\u{2699}",desc:"CRLP_RollupProcessor_SVC routes to correct handler by rollup type. Six specialized SVC classes: CRLP_RollupAccount_SVC, CRLP_RollupContact_SVC, CRLP_RollupSoftCredit_SVC, CRLP_RollupAccSoftCredit_SVC, CRLP_RollupGAU_SVC, CRLP_RollupRD_SVC.",tags:["CRLP_RollupProcessor_SVC","CRLP_Rollup_SVC","CRLP_Rollup_SEL"],triggerTags:["batch / trigger"],code:{title:"CRLP_RollupProcessor_SVC.cls",lang:"Apex",body:'<span class="cm">// Handler routing by rollup type</span>\n<span class="kw">public static</span> <span class="ty">Type</span> <span class="fn">getHandlerClassType</span>(\n    <span class="ty">CRLP_RollupProcessingOptions.RollupType</span>\n      rollupType) {\n  <span class="ty">Type</span> handlerClass;\n  <span class="kw">switch on</span> (rollupType) {\n    <span class="kw">when</span> ContactSoftCredit, AccountContactSoftCredit {\n      handlerClass = <span class="ty">CRLP_RollupSoftCredit_SVC</span>.class;\n    }\n    <span class="kw">when</span> AccountSoftCredit {\n      handlerClass = <span class="ty">CRLP_RollupAccSoftCredit_SVC</span>.class;\n    }\n    <span class="kw">when</span> AccountHardCredit {\n      handlerClass = <span class="ty">CRLP_RollupAccount_SVC</span>.class;\n    }\n    <span class="kw">when</span> ContactHardCredit {\n      handlerClass = <span class="ty">CRLP_RollupContact_SVC</span>.class;\n    }\n    <span class="kw">when</span> GAU {\n      handlerClass = <span class="ty">CRLP_RollupGAU_SVC</span>.class;\n    }\n    <span class="kw">when</span> RecurringDonations {\n      handlerClass = <span class="ty">CRLP_RollupRD_SVC</span>.class;\n    }\n  }\n  <span class="kw">return</span> handlerClass;\n}'},executionFlow:["Detail record (Opportunity/Payment) changes","CRLP_Rollup_TDTM fires, checks if CRLP is enabled","Loads Rollup__mdt definitions via CRLP_Rollup_SEL","Routes to correct SVC class by rollup type","Applies Filter_Group__mdt rules to exclude records","Calculates aggregate value per rollup definition","Updates target field on summary record"]},
    {id:"crlp-trigger",name:"Real-time Trigger",icon:"\u{26A1}",desc:"CRLP_Rollup_TDTM fires on Opportunity and Payment changes. Submits queueable jobs for async rollup processing. Guards against duplicate processing with alreadyQueuedForRollupJob Set. Falls back to legacy RLLP handlers when CRLP not enabled.",tags:["CRLP_Rollup_TDTM","RLLP_OppRollup_TDTM"],triggerTags:["after insert","after update","after delete"],code:{title:"CRLP_Rollup_TDTM.cls",lang:"Apex",body:'<span class="cm">// Real-time rollup trigger handler</span>\n<span class="kw">public class</span> <span class="ty">CRLP_Rollup_TDTM</span>\n  <span class="kw">extends</span> <span class="ty">TDTM_Runnable</span> {\n\n  <span class="kw">private static final</span> <span class="ty">Integer</span>\n    MAX_ALLOWED_QUEUED_JOBS = <span class="nu">5</span>;\n  <span class="kw">private static</span> <span class="ty">Set&lt;Id&gt;</span>\n    alreadyQueuedForRollupJob =\n      <span class="kw">new</span> <span class="ty">Set&lt;Id&gt;</span>();\n\n  <span class="kw">public override</span> <span class="ty">DmlWrapper</span> <span class="fn">run</span>(...) {\n    <span class="kw">if</span> (!<span class="ty">CRLP_Rollup_SVC</span>\n        .isCustomizableRollupEngineEnabled) {\n      <span class="kw">return null</span>;\n      <span class="cm">// Falls back to legacy RLLP handlers</span>\n    }\n    <span class="cm">// Submits queueable for async processing</span>\n  }\n}'},executionFlow:["Opportunity or Payment changes","CRLP_Rollup_TDTM checks if CRLP enabled","If disabled, falls back to legacy RLLP handlers","Identifies affected parent IDs","Checks alreadyQueuedForRollupJob to prevent dupes","Submits Queueable job for async rollup"]},
    {id:"crlp-batch",name:"Batch Rollup Jobs",icon:"\u{1F3ED}",desc:"14 batch classes extending CRLP_Batch_Base. NonSkew mode: CRLP_Account_BATCH, CRLP_Contact_BATCH, CRLP_GAU_BATCH, CRLP_RD_BATCH plus soft credit variants. SkewMode: CRLP_AccountSkew_BATCH, CRLP_ContactSkew_BATCH for accounts with many Opportunities. CRLP_SkewDispatcher_BATCH orchestrates skew processing.",tags:["CRLP_Batch_Base","CRLP_Account_BATCH","CRLP_SkewDispatcher_BATCH"],triggerTags:["scheduled batch"]},
    {id:"crlp-cmdt",name:"Rollup Configuration (CMDT)",icon:"\u{1F4DD}",desc:"Rollup__mdt defines each rollup: Summary_Object__c, Summary_Field__c, Detail_Object__c, Detail_Field__c, Operation__c, Filter_Group__c, Use_Fiscal_Year__c, Time_Bound_Operation_Type__c. Filter_Group__mdt + Filter_Rule__mdt for criteria. Ships with ~50 default definitions. Customizable_Rollup_Settings__c controls batch sizes and skew thresholds.",tags:["Rollup__mdt","Filter_Group__mdt","Filter_Rule__mdt","Customizable_Rollup_Settings__c"],triggerTags:["config"]}
  ],
  dataFlow:["Rollup__mdt (def)","Filter_Group__mdt","Detail Records","Calculate","Update Summary"],
  connections:[{planet:"donations",desc:"Donation changes are the primary rollup trigger"},{planet:"contacts",desc:"Rollup results written to Contact and Account"},{planet:"allocations",desc:"GAU allocation amounts roll up"},{planet:"batch",desc:"Full recalculation runs as batch Apex"},{planet:"softcredits",desc:"Separate rollup types for soft vs hard credits"},{planet:"recurring",desc:"RD rollup summaries"}]
},

softcredits: {
  name: "Soft Credits",
  icon: "\u{1F91D}",
  color: "#ec4899",
  description: "Attributes donations to contacts beyond the primary donor. Standard OCR-based soft credits via OpportunityContactRole, plus custom Partial Soft Credits (Partial_Soft_Credit__c) for splitting amounts. Account Soft Credits (Account_Soft_Credit__c) roll up at org level. Separate CRLP rollup types for soft vs hard credits.",
  components: [
    {id:"ocr-softcredit",name:"OCR Soft Credits",icon:"\u{1F465}",desc:"Uses standard OpportunityContactRole records. Any contact with a role on the Opportunity gets soft credit. OPP_OpportunityContactRoles_TDTM and HH_OppContactRoles_TDTM auto-create OCRs for household members.",tags:["OPP_OpportunityContactRoles_TDTM","HH_OppContactRoles_TDTM","OpportunityContactRole"],triggerTags:["after insert","after update"],code:{title:"Household OCR Creation",lang:"Apex",body:'<span class="cm">// Auto OCR creation for household members</span>\n<span class="kw">public class</span> <span class="ty">HH_OppContactRoles_TDTM</span>\n  <span class="kw">extends</span> <span class="ty">TDTM_Runnable</span> {\n\n  <span class="kw">public override</span> <span class="ty">DmlWrapper</span> <span class="fn">run</span>(...) {\n    <span class="ty">DmlWrapper</span> dml = <span class="kw">new</span> <span class="ty">DmlWrapper</span>();\n    <span class="kw">for</span> (<span class="ty">Opportunity</span> opp : opps) {\n      <span class="ty">List&lt;Contact&gt;</span> hhMembers =\n        <span class="fn">getHouseholdMembers</span>(opp.AccountId);\n      <span class="kw">for</span> (<span class="ty">Contact</span> member : hhMembers) {\n        <span class="kw">if</span> (member.Id != opp.ContactId) {\n          dml.objectsToInsert.add(\n            <span class="kw">new</span> <span class="ty">OpportunityContactRole</span>(\n              OpportunityId = opp.Id,\n              ContactId = member.Id,\n              Role = <span class="st">\'Household Member\'</span>\n          ));\n        }\n      }\n    }\n    <span class="kw">return</span> dml;\n  }\n}'},executionFlow:["Donation created with primary Contact","TDTM fires HH_OppContactRoles_TDTM","Queries household members from same Account","Creates OpportunityContactRole for each member","Soft credit rollups update on each credited Contact"]},
    {id:"partial-softcredit",name:"Partial Soft Credits",icon:"\u{2702}",desc:"Partial_Soft_Credit__c allows splitting soft credit amounts. PSC_PartialSoftCredit_TDTM validates on BeforeInsert/BeforeUpdate. PSC_Opportunity_TDTM manages Account_Soft_Credit__c records on Opportunity changes.",tags:["PSC_PartialSoftCredit_TDTM","PSC_Opportunity_TDTM","Partial_Soft_Credit__c","Account_Soft_Credit__c"],triggerTags:["before insert","after update"]}
  ],
  dataFlow:["Opportunity","OpportunityContactRole","Partial_Soft_Credit__c","Account_Soft_Credit__c","Rollup"],
  connections:[{planet:"donations",desc:"Soft credits attached to Opportunities"},{planet:"contacts",desc:"Credits attributed to Contact records"},{planet:"rollups",desc:"Separate CRLP rollup types for soft credits"}]
},

allocations: {
  name: "Allocations & Fund Accounting",
  icon: "\u{1F4C2}",
  color: "#06b6d4",
  description: "Distributes donation amounts across General Accounting Units (GAUs). 28 ALLO_ classes. Supports percentage-based or fixed-amount splits. Enforces no over-allocation. Allocation changes propagate between Opportunities and Payments, and from Recurring Donations to child Opportunities. ALLO_Multicurrency_TDTM handles currency adjustments.",
  components: [
    {id:"gau",name:"General Accounting Units",icon:"\u{1F3E6}",desc:"General_Accounting_Unit__c represents a fund, program, or accounting category. GAU_TDTM prevents deletion of GAUs with child allocations. Accumulates rollup totals via CRLP_GAU_BATCH.",tags:["General_Accounting_Unit__c","GAU_TDTM","CRLP_GAU_BATCH"],triggerTags:["rollup target"]},
    {id:"alloc-engine",name:"Allocation Engine",icon:"\u{1F4B1}",desc:"ALLO_Allocations_TDTM manages creation and enforcement on Allocation__c, Payment, and Opportunity objects. Supports default allocations (remainder goes to default GAU), percentage splits, and total validation.",tags:["ALLO_Allocations_TDTM","ALLO_PaymentSync_TDTM","Allocation__c","Allocations_Settings__c"],triggerTags:["after insert","after update"],code:{title:"ALLO_Allocations_TDTM.cls",lang:"Apex",body:'<span class="cm">// Allocation handler with settings facade</span>\n<span class="kw">public class</span> <span class="ty">ALLO_Allocations_TDTM</span>\n  <span class="kw">extends</span> <span class="ty">TDTM_Runnable</span> {\n\n  <span class="kw">public</span> <span class="ty">Map&lt;Id, alloWrapper&gt;</span> mapWrapper =\n    <span class="kw">new</span> <span class="ty">Map&lt;Id, alloWrapper&gt;</span>();\n\n  <span class="kw">public static</span> <span class="ty">Allocations_Settings__c</span> settings =\n    <span class="ty">UTIL_CustomSettingsFacade</span>\n      .<span class="fn">getAllocationsSettings</span>();\n\n  <span class="kw">public override</span> <span class="ty">DmlWrapper</span> <span class="fn">run</span>(...) {\n    <span class="cm">// Enforces allocation totals</span>\n    <span class="cm">// Calculates percentages</span>\n    <span class="cm">// Syncs between Opp and Payment allocs</span>\n  }\n}'},executionFlow:["Donation created or amount changed","ALLO_Allocations_TDTM fires (after)","Calculates total allocated vs Opportunity Amount","If under-allocated and default GAU set, creates allocation","ALLO_PaymentSync_TDTM syncs Payment allocations","GAU rollups recalculate via CRLP"]},
    {id:"alloc-multi",name:"Multicurrency Support",icon:"\u{1F4B1}",desc:"ALLO_Multicurrency_TDTM handles currency adjustments on Campaign and Recurring Donation objects. ALLO_MakeDefaultAllocations_BATCH creates default GAU allocations for existing records.",tags:["ALLO_Multicurrency_TDTM","ALLO_MakeDefaultAllocations_BATCH"],triggerTags:["after update","batch"]}
  ],
  dataFlow:["Opportunity/Payment","Allocation__c","General_Accounting_Unit__c","Rollup to GAU"],
  connections:[{planet:"donations",desc:"Allocations split donation amounts across funds"},{planet:"rollups",desc:"GAU totals maintained by CRLP_GAU_BATCH"},{planet:"recurring",desc:"RD allocations propagate to generated Opportunities"}]
},

tdtm: {
  name: "TDTM Framework",
  icon: "\u{26A1}",
  color: "#ef4444",
  description: "Table-Driven Trigger Management is NPSP's architectural foundation. ONE trigger per object dispatches to handler classes registered in Trigger_Handler__c custom SETTING (not CMDT). Two base classes: TDTM_Runnable (standard) and TDTM_RunnableMutable (for handlers needing record mutation). TDTM_DefaultConfig ships ~50 handler registrations. Admins can enable/disable handlers, control Load_Order__c, run handlers asynchronously, and exclude by username.",
  components: [
    {id:"tdtm-dispatcher",name:"TDTM Dispatcher",icon:"\u{1F4E1}",desc:"TDTM_TriggerHandler is the central dispatcher. Each object has one trigger calling TDTM_Config_API.run(). Queries Trigger_Handler__c, sorts by Load_Order__c, instantiates via Type.forName(), collects DmlWrapper results for batch DML.",tags:["TDTM_TriggerHandler","TDTM_Config_API","TDTM_TriggerActionHelper"],triggerTags:["all events"],code:{title:"TDTM Architecture (from actual source)",lang:"Apex",body:'<span class="cm">// 1. The Trigger (one per object)</span>\n<span class="kw">trigger</span> <span class="ty">TDTM_Contact</span> <span class="kw">on</span> <span class="ty">Contact</span> (\n  after delete, after insert, after undelete,\n  after update, before delete,\n  before insert, before update\n) {\n  <span class="ty">TDTM_Config_API</span>.<span class="fn">run</span>(\n    Trigger.isBefore, Trigger.isAfter,\n    Trigger.isInsert, Trigger.isUpdate,\n    Trigger.isDelete, Trigger.isUnDelete,\n    Trigger.new, Trigger.old,\n    Schema.Sobjecttype.Contact\n  );\n}\n\n<span class="cm">// 2. Abstract Base Classes</span>\n<span class="kw">global abstract class</span> <span class="ty">TDTM_Runnable</span> {\n  <span class="kw">global abstract</span> <span class="ty">DmlWrapper</span> <span class="fn">run</span>(\n    <span class="ty">List&lt;SObject&gt;</span> newlist,\n    <span class="ty">List&lt;SObject&gt;</span> oldlist,\n    <span class="ty">Action</span> triggerAction,\n    <span class="ty">Schema.DescribeSObjectResult</span> objResult\n  );\n  <span class="kw">global class</span> <span class="ty">DmlWrapper</span> {\n    <span class="kw">global</span> <span class="ty">List&lt;SObject&gt;</span> objectsToInsert;\n    <span class="kw">global</span> <span class="ty">List&lt;SObject&gt;</span> objectsToUpdate;\n    <span class="kw">global</span> <span class="ty">List&lt;SObject&gt;</span> objectsToDelete;\n    <span class="kw">global</span> <span class="ty">List&lt;SObject&gt;</span> objectsToUndelete;\n  }\n}\n\n<span class="cm">// TDTM_RunnableMutable: second base class</span>\n<span class="cm">// for handlers that need to mutate records</span>'},executionFlow:["DML operation fires the object's single trigger","Trigger calls TDTM_Config_API.run()","TDTM_TriggerHandler queries Trigger_Handler__c","Filters by Object__c, Active__c, Trigger_Action__c","Sorts by Load_Order__c","Instantiates each handler via Type.forName()","Calls handler.run() with trigger context","Collects DmlWrapper results for batch DML"]},
    {id:"tdtm-metadata",name:"Handler Registration",icon:"\u{1F4CB}",desc:"Trigger_Handler__c custom SETTING fields: Class__c, Object__c, Trigger_Action__c, Load_Order__c, Active__c, Asynchronous__c, User_Managed__c, Usernames_to_Exclude__c. TDTM_DefaultConfig defines ~50 default registrations. User_Managed__c prevents NPSP from overwriting customer handlers.",tags:["Trigger_Handler__c","TDTM_DefaultConfig","TDTM_ObjectDataGateway"],triggerTags:["configuration"],code:{title:"Handler Registration Fields",lang:"Apex",body:'<span class="cm">// Trigger_Handler__c (Custom SETTING, not CMDT)</span>\n<span class="cm">// Fields:</span>\nActive__c:        <span class="ty">Boolean</span>  <span class="cm">// enable/disable</span>\nAsynchronous__c:  <span class="ty">Boolean</span>  <span class="cm">// run as @future</span>\nClass__c:         <span class="ty">Text</span>     <span class="cm">// Apex class name</span>\nLoad_Order__c:    <span class="ty">Number</span>   <span class="cm">// execution order</span>\nObject__c:        <span class="ty">Text</span>     <span class="cm">// SObject API name</span>\nTrigger_Action__c: <span class="ty">Text</span>    <span class="cm">// "BeforeInsert;AfterUpdate"</span>\nUser_Managed__c:  <span class="ty">Boolean</span>  <span class="cm">// prevent NPSP overwrite</span>\nUsernames_to_Exclude__c: <span class="ty">Text</span> <span class="cm">// skip for users</span>\n\n<span class="cm">// Example from TDTM_DefaultConfig:</span>\nhandlers.add(<span class="kw">new</span> <span class="ty">Trigger_Handler__c</span>(\n  Active__c = <span class="kw">true</span>,\n  Class__c = <span class="st">\'PMT_Payment_TDTM\'</span>,\n  Object__c = <span class="st">\'Opportunity\'</span>,\n  Load_Order__c = <span class="nu">2</span>,\n  Trigger_Action__c =\n    <span class="st">\'AfterInsert;AfterUpdate\'</span>\n));'},executionFlow:["Admin opens NPSP Settings > TDTM page","Views all registered Trigger_Handler__c records","Can toggle Active__c to disable a handler","Can change Load_Order__c to reorder execution","Can add custom handler classes","User_Managed__c prevents NPSP overwrites"]},
    {id:"tdtm-recursion",name:"Recursion Guard",icon:"\u{1F6E1}",desc:"DmlWrapper collects all DML from handlers and executes in a single batch after all handlers run. TDTM_ProcessControl tracks which handlers have fired to prevent recursion. Ensures consistent state across the handler chain.",tags:["TDTM_ProcessControl","DmlWrapper"],triggerTags:["framework"]}
  ],
  dataFlow:["DML Event","Single Trigger","TDTM_Config_API","Query Handlers","Execute in Order","Collect DML","Batch Execute"],
  connections:[{planet:"donations",desc:"Opportunity trigger dispatches ~10 handlers"},{planet:"contacts",desc:"Contact trigger dispatches account, address, relationship handlers"},{planet:"recurring",desc:"Recurring Donation trigger dispatches RD2 handlers"},{planet:"settings",desc:"Handler config in Trigger_Handler__c custom setting"}]
},

batch: {
  name: "Batch Processing",
  icon: "\u{2699}",
  color: "#8b5cf6",
  description: "45 batch Apex classes handle async processing exceeding governor limits. Batch jobs cover: rollup recalculation (14 CRLP batches), recurring donation evaluation, data import/migration, household naming, level assignment, error processing, and address verification. Most run nightly or can be triggered from NPSP Settings.",
  components: [
    {id:"rollup-batches",name:"CRLP Batch Jobs",icon:"\u{1F4CA}",desc:"14 batch classes: CRLP_Account_BATCH, CRLP_Contact_BATCH, CRLP_GAU_BATCH, CRLP_RD_BATCH, plus soft credit and skew mode variants. All extend CRLP_Batch_Base. CRLP_SkewDispatcher_BATCH orchestrates skew processing for high-volume accounts.",tags:["CRLP_Batch_Base","CRLP_Account_BATCH","CRLP_Contact_BATCH","CRLP_SkewDispatcher_BATCH"],triggerTags:["scheduled"],code:{title:"CRLP Batch Pattern",lang:"Apex",body:'<span class="cm">// All CRLP batches extend CRLP_Batch_Base</span>\n<span class="kw">public class</span> <span class="ty">CRLP_Account_BATCH</span>\n  <span class="kw">extends</span> <span class="ty">CRLP_Batch_Base</span>\n  <span class="kw">implements</span> <span class="ty">Database.Batchable&lt;SObject&gt;</span>,\n             <span class="ty">Database.Stateful</span> {\n\n  <span class="kw">public</span> <span class="ty">Database.QueryLocator</span> <span class="fn">start</span>(\n    <span class="ty">Database.BatchableContext</span> bc\n  ) {\n    <span class="kw">return</span> <span class="ty">Database</span>.getQueryLocator(\n      <span class="st">\'SELECT Id FROM Account \'</span> +\n      <span class="st">\'WHERE npe01__SYSTEM_AccountType__c \'</span>+\n      <span class="st">\'IN (\\\'Household\\\',\\\'Organization\\\')\'</span>\n    );\n  }\n\n  <span class="kw">public void</span> <span class="fn">execute</span>(\n    <span class="ty">Database.BatchableContext</span> bc,\n    <span class="ty">List&lt;Account&gt;</span> scope\n  ) {\n    <span class="ty">CRLP_RollupProcessor</span> processor =\n      <span class="kw">new</span> <span class="ty">CRLP_RollupProcessor</span>();\n    processor.<span class="fn">completeRollup</span>(scope);\n    <span class="kw">update</span> scope;\n  }\n}'},executionFlow:["Scheduled job or manual trigger initiates batch","start() queries all target records","execute() processes in batches of 200","CRLP_RollupProcessor calculates rollups","Updates summary records with new values","finish() chains dependent batches"]},
    {id:"rd-batch",name:"RD Evaluation Batch",icon:"\u{1F504}",desc:"RD2_OpportunityEvaluation_BATCH processes all active Recurring Donations nightly. Creates new installments, updates statuses. RD2_DataMigration_BATCH migrates legacy to enhanced RDs.",tags:["RD2_OpportunityEvaluation_BATCH","RD2_DataMigration_BATCH"],triggerTags:["nightly"]},
    {id:"legacy-batches",name:"Legacy Rollup Batches",icon:"\u{1F4E6}",desc:"RLLP_OppAccRollup_BATCH, RLLP_OppContactRollup_BATCH, RLLP_OppHouseholdRollup_BATCH, RLLP_OppSoftCreditRollup_BATCH. Active when CRLP not enabled. 12 RLLP_ classes total.",tags:["RLLP_OppAccRollup_BATCH","RLLP_OppContactRollup_BATCH"],triggerTags:["legacy"]},
    {id:"other-batches",name:"Utility Batches",icon:"\u{1F527}",desc:"HH_HouseholdNaming_BATCH recalculates names. LVL_LevelAssign_BATCH assigns donor tiers. ALLO_MakeDefaultAllocations_BATCH creates defaults. OPP_OpportunityNaming_BATCH renames. ADDR_Validator_BATCH verifies addresses.",tags:["HH_HouseholdNaming_BATCH","LVL_LevelAssign_BATCH","ADDR_Validator_BATCH"],triggerTags:["utility"]}
  ],
  dataFlow:["Scheduled Trigger","Batch start()","Query Scope","execute() chunks","Process & Update","finish() + chain"],
  connections:[{planet:"rollups",desc:"CRLP batch jobs are the bulk rollup mechanism"},{planet:"recurring",desc:"RD evaluation batch manages installment pipeline"},{planet:"settings",desc:"Batch sizes configured in NPSP Settings"},{planet:"levels",desc:"LVL_LevelAssign_BATCH assigns donor tiers"}]
},

relationships: {
  name: "Relationships",
  icon: "\u{1F517}",
  color: "#f43f5e",
  description: "Tracks interpersonal relationships between Contacts (spouse, parent, employer, friend). 6 REL_ classes. Relationships are reciprocal: creating 'Father' from A to B auto-creates 'Son/Daughter' from B to A. REL_Relationships_Cm_TDTM auto-creates from CampaignMember co-membership. LWC: relationshipsNavigator, relationshipsTreeGrid.",
  components: [
    {id:"rel-reciprocal",name:"Reciprocal Relationships",icon:"\u{1F500}",desc:"REL_Relationships_TDTM fires on npe4__Relationship__c (AfterInsert/AfterUpdate/AfterDelete). Creates reciprocal relationship records automatically. Configurable relationship type mappings.",tags:["REL_Relationships_TDTM","npe4__Relationship__c"],triggerTags:["after insert","after update","after delete"],code:{title:"Reciprocal Relationship Pattern",lang:"Apex",body:'<span class="cm">// Three handlers for the Relationships domain:</span>\n\n<span class="cm">// 1. On Relationship object - creates reciprocals</span>\nhandlers.add(<span class="kw">new</span> <span class="ty">Trigger_Handler__c</span>(\n  Class__c = <span class="st">\'REL_Relationships_TDTM\'</span>,\n  Object__c = <span class="st">\'npe4__Relationship__c\'</span>,\n  Trigger_Action__c =\n    <span class="st">\'AfterInsert;AfterUpdate;AfterDelete\'</span>\n));\n\n<span class="cm">// 2. On Contact - syncs when contacts change</span>\nhandlers.add(<span class="kw">new</span> <span class="ty">Trigger_Handler__c</span>(\n  Class__c = <span class="st">\'REL_Relationships_Con_TDTM\'</span>,\n  Object__c = <span class="st">\'Contact\'</span>,\n  Trigger_Action__c =\n    <span class="st">\'AfterInsert;AfterUpdate;AfterDelete\'</span>\n));\n\n<span class="cm">// 3. On CampaignMember - auto-creates</span>\nhandlers.add(<span class="kw">new</span> <span class="ty">Trigger_Handler__c</span>(\n  Class__c = <span class="st">\'REL_Relationships_Cm_TDTM\'</span>,\n  Object__c = <span class="st">\'CampaignMember\'</span>,\n  Trigger_Action__c =\n    <span class="st">\'AfterInsert;AfterUpdate\'</span>\n));'},executionFlow:["User creates Relationship (A is Spouse of B)","REL_Relationships_TDTM fires (AfterInsert)","Looks up reciprocal type mapping","Creates reverse record (B is Spouse of A)","Both records linked via ReciprocalRelationship__c lookup"]},
    {id:"rel-contact",name:"Contact Sync",icon:"\u{1F465}",desc:"REL_Relationships_Con_TDTM syncs relationships when Contacts change (AfterInsert/AfterUpdate/AfterDelete). Preserves relationships during contact merge via CON_ContactMerge_TDTM.",tags:["REL_Relationships_Con_TDTM","npe4__Relationship_Settings__c"],triggerTags:["after insert","after update","after delete"]},
    {id:"rel-campaign",name:"Auto-Create from Campaigns",icon:"\u{1F4E3}",desc:"REL_Relationships_Cm_TDTM auto-creates relationships when Contacts are co-members of a Campaign. Configurable via Relationship_Auto_Create_Settings__c.",tags:["REL_Relationships_Cm_TDTM","CampaignMember"],triggerTags:["after insert","after update"]}
  ],
  dataFlow:["Contact A","Relationship__c","Reciprocal auto-created","Contact B"],
  connections:[{planet:"contacts",desc:"Relationships exist between Contacts"},{planet:"contacts",desc:"Preserved during contact merges"}]
},

addresses: {
  name: "Address Management",
  icon: "\u{1F4CD}",
  color: "#14b8a6",
  description: "Manages addresses as first-class objects (Address__c) linked to Accounts. 20 ADDR_ classes. Supports seasonal/mailing addresses, household sharing, and optional verification/normalization. When Address__c is updated, changes propagate to parent Account and all household Contact records. ADDR_Validator_TDTM supports async execution for external verification services.",
  components: [
    {id:"addr-core",name:"Address Object & Sync",icon:"\u{1F3E0}",desc:"ADDR_Addresses_TDTM is the main handler on Address__c (Before/AfterInsert, Before/AfterUpdate, AfterDelete). Copies address fields to Account and all household Contacts. Supports configurable async execution.",tags:["ADDR_Addresses_TDTM","Address__c"],triggerTags:["before insert","after insert","after update","after delete"],code:{title:"Address Handler (Async-Capable)",lang:"Apex",body:'<span class="cm">// Address handler supports async execution</span>\nhandlers.add(<span class="kw">new</span> <span class="ty">Trigger_Handler__c</span>(\n  Active__c = <span class="kw">true</span>,\n  <span class="cm">// Asynchronous__c is configurable!</span>\n  Asynchronous__c = <span class="kw">false</span>,\n  Class__c = <span class="st">\'ADDR_Addresses_TDTM\'</span>,\n  Load_Order__c = <span class="nu">1</span>,\n  Object__c = <span class="st">\'Address__c\'</span>,\n  Trigger_Action__c =\n    <span class="st">\'BeforeInsert;BeforeUpdate;\'</span>\n    + <span class="st">\'AfterInsert;AfterUpdate;AfterDelete\'</span>\n));'},executionFlow:["Address__c record created or modified","ADDR_Addresses_TDTM fires (before/after)","Identifies parent Account and household Contacts","Copies address fields to Account billing/shipping","Syncs address to all household member Contacts","Handles seasonal address logic"]},
    {id:"addr-contact",name:"Contact Address Sync",icon:"\u{1F464}",desc:"ADDR_Contact_TDTM creates Address__c records from Contact address fields. ADDR_Account_TDTM creates from Account address fields. Bidirectional sync between Address__c and standard address fields.",tags:["ADDR_Contact_TDTM","ADDR_Account_TDTM"],triggerTags:["after insert","after update"]},
    {id:"addr-verify",name:"Address Verification",icon:"\u{2705}",desc:"ADDR_Validator_TDTM provides address verification/normalization through external services. Supports async execution. ADDR_Validator_BATCH for bulk verification. Settings in Addr_Verification_Settings__c.",tags:["ADDR_Validator_TDTM","ADDR_Validator_BATCH","Addr_Verification_Settings__c"],triggerTags:["after insert","after update"]}
  ],
  dataFlow:["Address__c","Account (billing/shipping)","Contact (mailing)","Verification Service"],
  connections:[{planet:"contacts",desc:"Addresses shared across household members"},{planet:"batch",desc:"ADDR_Validator_BATCH for bulk verification"}]
},

affiliations: {
  name: "Affiliations",
  icon: "\u{1F3E2}",
  color: "#6366f1",
  description: "Links Contacts to organizational Accounts (employer, board membership, volunteer role). Unlike Relationships (contact-to-contact), Affiliations are contact-to-organization. AFFL_Affiliations_TDTM is unique: the same class is registered on THREE different objects (Account, Contact, and Affiliation__c) with different load orders.",
  components: [
    {id:"affl-core",name:"Affiliation Engine",icon:"\u{1F517}",desc:"AFFL_Affiliations_TDTM fires on Account (AfterInsert/AfterUpdate, order 2), Contact (AfterInsert/AfterUpdate, order 1), and npe5__Affiliation__c (After*, order 1). Supports primary affiliation designation and status tracking.",tags:["AFFL_Affiliations_TDTM","npe5__Affiliation__c"],triggerTags:["after insert","after update","after delete"],code:{title:"AFFL on Three Objects",lang:"Apex",body:'<span class="cm">// Same class on THREE objects:</span>\n\n<span class="cm">// On Account (load order 2)</span>\nhandlers.add(<span class="kw">new</span> <span class="ty">Trigger_Handler__c</span>(\n  Class__c = <span class="st">\'AFFL_Affiliations_TDTM\'</span>,\n  Load_Order__c = <span class="nu">2</span>,\n  Object__c = <span class="st">\'Account\'</span>,\n  Trigger_Action__c =\n    <span class="st">\'AfterInsert;AfterUpdate\'</span>\n));\n\n<span class="cm">// On Contact (load order 1)</span>\nhandlers.add(<span class="kw">new</span> <span class="ty">Trigger_Handler__c</span>(\n  Class__c = <span class="st">\'AFFL_Affiliations_TDTM\'</span>,\n  Load_Order__c = <span class="nu">1</span>,\n  Object__c = <span class="st">\'Contact\'</span>,\n  Trigger_Action__c =\n    <span class="st">\'AfterInsert;AfterUpdate\'</span>\n));\n\n<span class="cm">// On Affiliation itself (load order 1)</span>\nhandlers.add(<span class="kw">new</span> <span class="ty">Trigger_Handler__c</span>(\n  Class__c = <span class="st">\'AFFL_Affiliations_TDTM\'</span>,\n  Load_Order__c = <span class="nu">1</span>,\n  Object__c = <span class="st">\'npe5__Affiliation__c\'</span>,\n  Trigger_Action__c =\n    <span class="st">\'AfterInsert;AfterUpdate;\'</span>\n    + <span class="st">\'AfterDelete;AfterUndelete\'</span>\n));'},executionFlow:["Contact associated with Organization Account","AFFL_Affiliations_TDTM fires on Contact (AfterInsert)","Creates npe5__Affiliation__c junction record","Sets primary affiliation if first for Contact","Status tracking: Current, Former, etc.","Role tracking: Employee, Board Member, Volunteer"]}
  ],
  dataFlow:["Contact","npe5__Affiliation__c","Organization Account"],
  connections:[{planet:"contacts",desc:"Contacts are affiliated with organizations"},{planet:"donations",desc:"Employment affiliations identify matching gift eligibility"}]
},

engagement: {
  name: "Engagement Plans",
  icon: "\u{1F4CB}",
  color: "#84cc16",
  description: "Templated sequences of Tasks for stewardship workflows. 12 EP_ classes. Templates define tasks with dependencies, delays, and assignment rules. Apply a template to a Contact, Account, or Opportunity and Tasks auto-generate. Task completion rolls up to the engagement plan.",
  components: [
    {id:"ep-core",name:"Plan Engine",icon:"\u{2699}",desc:"EP_EngagementPlans_TDTM validates plan lookups (BeforeInsert) and creates Tasks from templates (AfterInsert). Validates that each plan links to exactly one parent object. Uses DML options for email sending on certain tasks.",tags:["EP_EngagementPlans_TDTM","Engagement_Plan__c","Engagement_Plan_Template__c"],triggerTags:["before insert","after insert"],code:{title:"EP_EngagementPlans_TDTM.cls",lang:"Apex",body:'<span class="kw">public with sharing class</span>\n  <span class="ty">EP_EngagementPlans_TDTM</span>\n  <span class="kw">extends</span> <span class="ty">TDTM_Runnable</span> {\n\n  <span class="kw">public override</span> <span class="ty">DmlWrapper</span> <span class="fn">run</span>(...) {\n    <span class="kw">if</span> (triggerAction ==\n        <span class="ty">Action</span>.BeforeInsert) {\n      <span class="kw">for</span> (<span class="ty">Engagement_Plan__c</span> ep : newlist){\n        <span class="cm">// Validate exactly one parent lookup</span>\n        <span class="ty">String</span> targetField =\n          <span class="ty">EP_EngagementPlans_UTIL</span>\n            .<span class="fn">getTargetObjectField</span>(ep, <span class="kw">true</span>);\n      }\n    }\n    <span class="cm">// AfterInsert: Creates Task records</span>\n    <span class="cm">// from EP_Task definitions in template</span>\n  }\n}'},executionFlow:["Admin creates Engagement_Plan_Template__c with task definitions","User applies template to Contact/Account/Opportunity","EP_EngagementPlans_TDTM validates (BeforeInsert)","Creates Task records based on template definitions","EP_TaskDependency_TDTM manages task dependency chains","EP_TaskRollup_TDTM rolls up completion to plan"]},
    {id:"ep-tasks",name:"Task Management",icon:"\u{1F4DD}",desc:"EP_TaskRollup_TDTM rolls up task completion status. EP_TaskDependency_TDTM manages dependency chains (task B starts when task A completes). EP_EngagementPlanTaskValidation_TDTM validates task definitions.",tags:["EP_TaskRollup_TDTM","EP_TaskDependency_TDTM","Engagement_Plan_Task__c"],triggerTags:["after update"]}
  ],
  dataFlow:["Template","Engagement_Plan__c","Task Records","Completion Rollup"],
  connections:[{planet:"contacts",desc:"Plans assigned to Contacts"},{planet:"donations",desc:"Plans triggered by donation events"}]
},

bdi: {
  name: "Batch Data Import (BDI)",
  icon: "\u{1F4E5}",
  color: "#d97706",
  description: "Powerful data import engine with 66 Apex classes. Loads donations, contacts, and records through a staging object (DataImport__c). Custom metadata field/object mappings (Data_Import_Field_Mapping__mdt, Data_Import_Object_Mapping__mdt). Donation matching prevents duplicates. Gift Entry UI is built on top of BDI.",
  components: [
    {id:"bdi-batch",name:"BDI Batch Processor",icon:"\u{2699}",desc:"BDI_DataImport_BATCH implements Database.Batchable. Processes DataImport__c staging records: matches/creates Contacts, Accounts, Opportunities, Payments, Allocations, and other mapped objects. BDI_MatchDonations prevents duplicate donations.",tags:["BDI_DataImport_BATCH","BDI_DataImportService","BDI_MatchDonations"],triggerTags:["batch"],code:{title:"BDI_DataImport_BATCH.cls",lang:"Apex",body:'<span class="kw">public class</span> <span class="ty">BDI_DataImport_BATCH</span>\n  <span class="kw">implements</span> <span class="ty">Database.Batchable&lt;sObject&gt;</span> {\n\n  <span class="kw">private</span> <span class="ty">BDI_DataImportService</span>\n    dataImportService;\n  <span class="kw">public</span> <span class="ty">Data_Import_Settings__c</span> diSettings;\n  <span class="kw">public</span> <span class="ty">Id</span> batchId;\n  <span class="kw">public</span> <span class="ty">Boolean</span> isFromGiftEntryUI;\n\n  <span class="cm">// Processes DataImport__c records:</span>\n  <span class="cm">//   1. Contacts and Accounts</span>\n  <span class="cm">//   2. Opportunities (with matching)</span>\n  <span class="cm">//   3. Payments</span>\n  <span class="cm">//   4. Allocations</span>\n  <span class="cm">//   5. Other mapped objects</span>\n}'},executionFlow:["DataImport__c staging records created","BDI_DataImport_BATCH processes in batches","BDI_MappingService resolves field mappings from CMDT","BDI_MatchDonations checks for existing Opportunities","Creates/updates Contacts, Accounts, Opportunities","Creates Payments and Allocations","Updates DataImport__c status fields"]},
    {id:"bdi-mapping",name:"Field Mapping Engine",icon:"\u{1F5FA}",desc:"BDI_MappingService resolves field-to-field mappings via Data_Import_Field_Mapping__mdt CMDT. BDI_ObjectMappingLogic handles object creation/matching via Data_Import_Object_Mapping__mdt. LWC components: bdiFieldMappings, bdiObjectMappings.",tags:["BDI_MappingService","BDI_ObjectMappingLogic","Data_Import_Field_Mapping__mdt","Data_Import_Object_Mapping__mdt"],triggerTags:["config"]},
    {id:"bdi-triggers",name:"BDI Trigger Handlers",icon:"\u{26A1}",desc:"BDI_DataImportBatch_TDTM fires on DataImportBatch__c (BeforeInsert). BDI_DataImportBatchStatus_TDTM tracks batch status via DataImport__c record counts.",tags:["BDI_DataImportBatch_TDTM","BDI_DataImportBatchStatus_TDTM","DataImport__c","DataImportBatch__c"],triggerTags:["before insert"]}
  ],
  dataFlow:["DataImport__c (staging)","BDI_MappingService","Match/Create","Contact + Account + Opportunity","Payment + Allocation"],
  connections:[{planet:"giftentry",desc:"Gift Entry UI is built on BDI"},{planet:"donations",desc:"Creates Opportunities and Payments"},{planet:"contacts",desc:"Creates/matches Contacts and Accounts"},{planet:"allocations",desc:"Creates allocations during import"}]
},

giftentry: {
  name: "Gift Entry",
  icon: "\u{1F381}",
  color: "#0ea5e9",
  description: "Modern Lightning-based gift entry built on BDI. 10 GE_ classes, 9 BGE_ classes, 20+ LWC components. Form templates (Form_Template__c) drive dynamic form rendering. Supports single entry, batch entry with table views, Elevate card tokenization, donation matching, soft credit and allocation widgets.",
  components: [
    {id:"ge-form",name:"Gift Entry Forms",icon:"\u{1F4DD}",desc:"geGiftEntryFormApp is the main LWC. geFormRenderer dynamically renders fields from template JSON. geFormField, geFormSection handle individual elements. geFormWidgetAllocation and geFormWidgetSoftCredit provide inline allocation/soft credit entry.",tags:["GE_GiftEntryController","geGiftEntryFormApp","geFormRenderer"],triggerTags:["LWC"],code:{title:"Gift Entry Data Flow",lang:"JavaScript",body:'<span class="cm">// Gift Entry LWC Architecture:</span>\n<span class="cm">// geGiftEntryFormApp coordinates:</span>\n<span class="cm">//   geFormRenderer - renders from template JSON</span>\n<span class="cm">//   geFormWidgetAllocation - allocation splits</span>\n<span class="cm">//   geFormWidgetSoftCredit - soft credit entry</span>\n<span class="cm">//   geFormWidgetTokenizeCard - Elevate card</span>\n<span class="cm">//   geDonationMatching - finds matches</span>\n<span class="cm">//</span>\n<span class="cm">// Data flow:</span>\n<span class="cm">// User fills form</span>\n<span class="cm">//   -> DataImport__c staging record created</span>\n<span class="cm">//   -> BDI_DataImport_BATCH processes</span>\n<span class="cm">//   -> Opportunity + Payment created</span>'},executionFlow:["User opens Gift Entry page","geFormRenderer loads Form_Template__c JSON","Dynamic form rendered with configured fields","User enters donation data","DataImport__c staging record created","BDI_DataImport_BATCH processes the record","Opportunity, Payment, Allocations created"]},
    {id:"ge-batch",name:"Batch Gift Entry",icon:"\u{1F4CB}",desc:"geBatchGiftEntryHeader + geBatchGiftEntryTable provide batch entry with spreadsheet-like table views. geBatchWizard creates new batches. BGE_FormTemplate_TDTM prevents deletion of active templates.",tags:["BGE_FormTemplate_TDTM","geBatchGiftEntryTable","DataImportBatch__c"],triggerTags:["before delete"]},
    {id:"ge-templates",name:"Template Builder",icon:"\u{1F3A8}",desc:"geTemplateBuilder provides a drag-and-drop form designer. Templates stored as JSON in Form_Template__c. geTemplates shows template list view. GE_Template manages template CRUD operations.",tags:["geTemplateBuilder","Form_Template__c","GE_Template"],triggerTags:["config"]}
  ],
  dataFlow:["Form Template","User Input","DataImport__c","BDI Processing","Opportunity + Payment"],
  connections:[{planet:"bdi",desc:"Gift Entry uses BDI as processing engine"},{planet:"donations",desc:"Creates Opportunities and Payments"},{planet:"elevate",desc:"Card tokenization during entry"},{planet:"softcredits",desc:"Soft credit widget in forms"},{planet:"allocations",desc:"Allocation widget in forms"}]
},

levels: {
  name: "Levels (Donor Tiers)",
  icon: "\u{1F3C6}",
  color: "#10b981",
  description: "Assigns donor tiers based on rollup field values. 6 LVL_ classes. For example, donors giving $10,000+ lifetime auto-assigned 'Major Donor' level. Levels target Account, Contact, or any object. LVL_LevelAssign_BATCH evaluates all records nightly against Level__c criteria definitions.",
  components: [
    {id:"lvl-engine",name:"Level Assignment Engine",icon:"\u{2699}",desc:"LVL_Level_TDTM validates Level__c records (BeforeInsert/BeforeUpdate). LVL_LevelAssign_BATCH runs nightly: queries all Level__c definitions, evaluates records against min/max criteria, assigns appropriate level and tracks previous level.",tags:["LVL_Level_TDTM","LVL_LevelAssign_BATCH","Level__c","Levels_Settings__c"],triggerTags:["before insert","nightly batch"],code:{title:"Level Assignment Pattern",lang:"Apex",body:'<span class="cm">// Level validation and batch assignment</span>\nhandlers.add(<span class="kw">new</span> <span class="ty">Trigger_Handler__c</span>(\n  Class__c = <span class="st">\'LVL_Level_TDTM\'</span>,\n  Load_Order__c = <span class="nu">1</span>,\n  Object__c = <span class="st">\'Level__c\'</span>,\n  Trigger_Action__c =\n    <span class="st">\'BeforeInsert;BeforeUpdate\'</span>\n));\n\n<span class="cm">// LVL_LevelAssign_BATCH nightly:</span>\n<span class="cm">// 1. Query all Level__c definitions</span>\n<span class="cm">// 2. For each target object, query records</span>\n<span class="cm">// 3. Assign level based on field value ranges</span>\n<span class="cm">// 4. Update Previous_Level__c and Level__c</span>\n<span class="cm">//</span>\n<span class="cm">// Example Level__c record:</span>\n<span class="cm">//   Name: "Major Donor"</span>\n<span class="cm">//   Target: Contact</span>\n<span class="cm">//   Source_Field: npo02__TotalOppAmount__c</span>\n<span class="cm">//   Minimum_Amount: 10000</span>\n<span class="cm">//   Maximum_Amount: null (no cap)</span>'},executionFlow:["Admin defines Level__c records with criteria","LVL_Level_TDTM validates on save","Nightly: LVL_LevelAssign_BATCH runs","Queries Level__c definitions by target object","Evaluates each record against min/max thresholds","Assigns Level__c lookup, tracks Previous_Level__c"]}
  ],
  dataFlow:["Level__c (definition)","Rollup Fields","LVL_LevelAssign_BATCH","Contact/Account Level Assignment"],
  connections:[{planet:"rollups",desc:"Level criteria based on rollup summary fields"},{planet:"contacts",desc:"Levels assigned to Contacts and Accounts"},{planet:"batch",desc:"LVL_LevelAssign_BATCH runs nightly"}]
},

errors: {
  name: "Error Handling",
  icon: "\u{26A0}",
  color: "#d946ef",
  description: "Centralized error framework with 22 ERR_ classes. Catches exceptions from TDTM handlers, logs to Error__c custom object, optionally sends email notifications. ERR_Handler processes DML results, ERR_Notifier sends alerts, ERR_ExceptionHandler converts exceptions, ERR_RecordError tracks record-level issues.",
  components: [
    {id:"err-handler",name:"Error Handler",icon:"\u{1F6A8}",desc:"ERR_Handler is the core processor. Converts Database.SaveResult/UpsertResult to Error__c records with full context (stack trace, record IDs, handler name). Does NOT store errors directly; caller handles after rollback.",tags:["ERR_Handler","ERR_ExceptionHandler","Error__c"],triggerTags:["system"],code:{title:"ERR_Handler Pattern",lang:"Apex",body:'<span class="kw">public class</span> <span class="ty">ERR_Handler</span> {\n\n  <span class="kw">public class</span> <span class="ty">Errors</span> {\n    <span class="kw">public</span> <span class="ty">Boolean</span> errorsExist = <span class="kw">false</span>;\n    <span class="kw">public</span> <span class="ty">List&lt;Error__c&gt;</span> errorRecords =\n      <span class="kw">new</span> <span class="ty">List&lt;Error__c&gt;</span>();\n  }\n\n  <span class="cm">// Processes DML results:</span>\n  <span class="cm">// 1. Iterates SaveResult[]</span>\n  <span class="cm">// 2. Creates Error__c with full context</span>\n  <span class="cm">// 3. Caller handles after rollback</span>\n  <span class="cm">// 4. ERR_Notifier sends email alerts</span>\n}'},executionFlow:["TDTM handler throws exception or DML fails","ERR_Handler.processErrors() called","Creates Error__c records with stack trace and context","ERR_Notifier checks Error_Settings__c","Sends email notification if configured","Admin reviews errors in NPSP Settings"]},
    {id:"err-notifier",name:"Error Notification",icon:"\u{1F4E7}",desc:"ERR_Notifier sends email alerts for errors. Configurable via Error_Settings__c (notification recipients, frequency). errRecordLog LWC provides error log viewer in Settings UI.",tags:["ERR_Notifier","Error_Settings__c","errRecordLog"],triggerTags:["notification"]},
    {id:"err-record",name:"Record-Level Errors",icon:"\u{1F4DD}",desc:"ERR_RecordError tracks errors at the individual record level. Enables retry logic and targeted error resolution. Error__c stores object type, record ID, error message, stack trace, and handler class name.",tags:["ERR_RecordError","Error__c"],triggerTags:["tracking"]}
  ],
  dataFlow:["Exception/DML Failure","ERR_Handler","Error__c Record","ERR_Notifier","Admin Review"],
  connections:[{planet:"tdtm",desc:"Errors caught from TDTM handler chain"},{planet:"settings",desc:"Error_Settings__c configures notifications"},{planet:"batch",desc:"Batch job errors logged through ERR_Handler"}]
},

settings: {
  name: "Settings & Configuration",
  icon: "\u{2699}",
  color: "#64748b",
  description: "All config stored in 14+ Custom Settings objects, managed through UTIL_CustomSettingsFacade (unified facade with in-memory caching). 64 STG_ classes for Visualforce settings panels. LWC: gsChecklist, gsChecklistSetup for getting-started wizard. STG_InstallScript handles package install/upgrade.",
  components: [
    {id:"settings-facade",name:"Settings Facade",icon:"\u{1F3E0}",desc:"UTIL_CustomSettingsFacade provides unified access to all 14+ custom settings with in-memory caching. Every NPSP handler calls this facade. Settings objects include: Contacts_And_Orgs, Households, Recurring_Donations, Relationships, Allocations, Rollups, Data_Import, Error, Address_Verification, Levels, Gift_Entry, and more.",tags:["UTIL_CustomSettingsFacade","npe01__Contacts_And_Orgs_Settings__c","npo02__Households_Settings__c"],triggerTags:["foundation"],code:{title:"UTIL_CustomSettingsFacade.cls",lang:"Apex",body:'<span class="kw">public without sharing class</span>\n  <span class="ty">UTIL_CustomSettingsFacade</span> {\n\n  <span class="cm">// In-memory caching for all settings</span>\n  <span class="kw">static</span> <span class="ty">npe01__Contacts_And_Orgs_Settings__c</span>\n    contactsSettings;\n  <span class="kw">static</span> <span class="ty">npo02__Households_Settings__c</span>\n    householdsSettings;\n  <span class="kw">static</span> <span class="ty">npe03__Recurring_Donations_Settings__c</span>\n    recurringDonationsSettings;\n  <span class="kw">static</span> <span class="ty">Allocations_Settings__c</span>\n    allocationsSettings;\n  <span class="kw">static</span> <span class="ty">Customizable_Rollup_Settings__c</span>\n    customizableRollupSettings;\n  <span class="kw">static</span> <span class="ty">Data_Import_Settings__c</span>\n    dataImportSettings;\n  <span class="cm">// ... 14+ settings objects cached</span>\n\n  <span class="cm">// Usage throughout NPSP:</span>\n  <span class="cm">// PMT_Payment_TDTM:</span>\n  <span class="cm">//   getContactsSettings()</span>\n  <span class="cm">//     .Enforce_Accounting_Data_Consistency__c</span>\n  <span class="cm">// ALLO_Allocations_TDTM:</span>\n  <span class="cm">//   getAllocationsSettings()</span>\n}'},executionFlow:["Handler needs configuration value","Calls UTIL_CustomSettingsFacade.getXxxSettings()","Facade checks in-memory cache","If cached, returns immediately (no query)","If not cached, queries Custom Setting and caches","Returns settings object to caller"]},
    {id:"settings-ui",name:"Settings UI",icon:"\u{1F5A5}",desc:"64 STG_ classes provide Visualforce settings panels organized by domain: Donations, People, Recurring Donations, Bulk Data, System Tools. LWC getting-started: gsChecklist, gsChecklistSetup, gsApplicationStatus, gsResources.",tags:["STG_Panel","STG_PanelTDTM_CTRL","gsChecklist"],triggerTags:["UI"]},
    {id:"health-check",name:"Health Check & Install",icon:"\u{1FA7A}",desc:"STG_PanelHealthCheck validates: TDTM handler registration, required fields, rollup definitions, record type mappings, configuration conflicts. STG_InstallScript handles package install and upgrade logic.",tags:["STG_PanelHealthCheck","STG_InstallScript"],triggerTags:["diagnostic"]}
  ],
  dataFlow:["Admin UI","Custom Settings (14+)","UTIL_CustomSettingsFacade","Handler Behavior","Batch Schedules"],
  connections:[{planet:"tdtm",desc:"Handler records managed via Settings"},{planet:"rollups",desc:"Rollup definitions through Settings UI"},{planet:"batch",desc:"Batch sizes and schedules in Settings"},{planet:"errors",desc:"Error notification configured in Settings"}]
},

elevate: {
  name: "Payment Services (Elevate)",
  icon: "\u{1F4B3}",
  color: "#7c3aed",
  description: "Integration with Salesforce Elevate for payment processing. 14 PS_ classes. Handles credit card tokenization, payment capture, refunds, and recurring payment management. LWC components handle card entry and token management.",
  components: [
    {id:"ps-core",name:"Payment Integration",icon:"\u{1F310}",desc:"PS_CommitmentRequest builds Elevate commitment requests for recurring payments. PS_Request is the base request builder. PS_IntegrationService handles HTTP callouts to Elevate APIs. Configuration in Payment_Services_Configuration__c.",tags:["PS_CommitmentRequest","PS_Request","PS_IntegrationService","Payment_Services_Configuration__c"],triggerTags:["callout"],code:{title:"Payment Services Architecture",lang:"Apex",body:'<span class="cm">// Payment Services integration:</span>\n<span class="cm">// PS_CommitmentRequest - recurring payment JSON</span>\n<span class="cm">// PS_Request - base class for Elevate API</span>\n<span class="cm">// PS_IntegrationService - HTTP callout mgmt</span>\n<span class="cm">//</span>\n<span class="cm">// LWC flow:</span>\n<span class="cm">// geFormWidgetTokenizeCard</span>\n<span class="cm">//   -> iframe -> Elevate tokenization service</span>\n<span class="cm">//   -> token returned</span>\n<span class="cm">//   -> stored on</span>\n<span class="cm">//      DataImport__c.Payment_Method_Token__c</span>\n<span class="cm">//   -> BDI processing captures payment</span>\n<span class="cm">//      via Elevate API</span>'},executionFlow:["User enters card in geFormWidgetTokenizeCard","Iframe communicates with Elevate tokenization","Token returned and stored on DataImport__c","BDI processes the staging record","PS_IntegrationService captures payment via Elevate API","Payment confirmation stored on npe01__OppPayment__c"]},
    {id:"ps-lwc",name:"Payment UI Components",icon:"\u{1F4BB}",desc:"geFormWidgetTokenizeCard for card entry, gePaymentGatewayManagement for gateway config, rd2EditPaymentInformationModal and rd2ElevateCreditCardForm for recurring donation payment editing, refundPayment for refunds.",tags:["geFormWidgetTokenizeCard","rd2ElevateCreditCardForm","refundPayment"],triggerTags:["LWC"]}
  ],
  dataFlow:["Card Entry (LWC)","Elevate Tokenization","Token Storage","BDI Processing","Payment Capture"],
  connections:[{planet:"giftentry",desc:"Card tokenization during gift entry"},{planet:"recurring",desc:"Recurring payment processing"},{planet:"donations",desc:"Payment capture and refunds"}]
}

};

const PLANET_META = {};
for (const [k,v] of Object.entries(NPSP)) { PLANET_META[k] = {icon:v.icon, color:v.color}; }

let currentLevel="galaxy", currentPlanet=null, currentComponent=null, navHistory=[];

// ── Starfield ──
function initStarfield(){const c=document.getElementById("starfield"),x=c.getContext("2d");c.width=innerWidth;c.height=innerHeight;const s=[];for(let i=0;i<350;i++)s.push({x:Math.random()*c.width,y:Math.random()*c.height,sz:Math.random()*1.5+0.3,op:Math.random()*0.8+0.2,tw:Math.random()*0.02+0.005});let f=0;(function a(){x.clearRect(0,0,c.width,c.height);f++;for(const st of s){const t=Math.sin(f*st.tw)*0.3+0.7;x.beginPath();x.arc(st.x,st.y,st.sz,0,Math.PI*2);x.fillStyle=`rgba(180,200,255,${st.op*t})`;x.fill()}requestAnimationFrame(a)})();addEventListener("resize",()=>{c.width=innerWidth;c.height=innerHeight})}

// ── Views ──
function showView(id,dir){document.querySelectorAll(".view-layer").forEach(v=>{if(v.classList.contains("active")){v.classList.remove("active");v.classList.add(dir==="in"?"zoom-out":"zoom-in");setTimeout(()=>v.classList.remove("zoom-out","zoom-in"),800)}});const t=document.getElementById(id);t.classList.remove("zoom-out","zoom-in");t.classList.add(dir==="in"?"zoom-in":"zoom-out");requestAnimationFrame(()=>requestAnimationFrame(()=>{t.classList.remove("zoom-out","zoom-in");t.classList.add("active")}))}

function updateBreadcrumb(){const bc=document.getElementById("breadcrumb");let h='<span class="crumb'+(currentLevel==="galaxy"?" active":"")+'" onclick="navigateTo(\'galaxy\')">Galaxy</span>';if(currentPlanet){h+='<span class="crumb-sep">\u25B8</span><span class="crumb'+(currentLevel==="planet"?" active":"")+'" onclick="navigateTo(\'planet\')">'+NPSP[currentPlanet].name+"</span>"}if(currentComponent){const c=NPSP[currentPlanet].components.find(x=>x.id===currentComponent);if(c)h+='<span class="crumb-sep">\u25B8</span><span class="crumb active">'+c.name+"</span>"}bc.innerHTML=h;document.querySelectorAll(".zoom-dot").forEach((d,i)=>d.classList.toggle("active",(i===0&&currentLevel==="galaxy")||(i===1&&currentLevel==="planet")||(i===2&&currentLevel==="core")));document.getElementById("backBtn").classList.toggle("visible",currentLevel!=="galaxy")}

function enterPlanet(id){navHistory.push({level:currentLevel,planet:currentPlanet,component:currentComponent});currentLevel="planet";currentPlanet=id;currentComponent=null;renderPlanetView(id);showView("planet-view","in");updateBreadcrumb()}

function enterCore(pid,cid){navHistory.push({level:currentLevel,planet:currentPlanet,component:currentComponent});currentLevel="core";currentComponent=cid;renderCoreView(pid,cid);showView("core-view","in");updateBreadcrumb()}

function navigateTo(level){if(level===currentLevel)return;if(level==="galaxy"){currentLevel="galaxy";currentPlanet=null;currentComponent=null;showView("galaxy-view","out")}else if(level==="planet"){currentLevel="planet";currentComponent=null;showView("planet-view","out")}updateBreadcrumb()}

function goBack(){if(navHistory.length>0){const p=navHistory.pop();if(p.level==="galaxy")navigateTo("galaxy");else if(p.level==="planet"){currentPlanet=p.planet;navigateTo("planet")}}else{if(currentLevel==="core")navigateTo("planet");else if(currentLevel==="planet")navigateTo("galaxy")}}

// ── Render Planet ──
function renderPlanetView(id){const p=NPSP[id],el=document.getElementById("planet-content");el.innerHTML=`<div class="planet-header"><div class="planet-header-orb" style="background:${p.color};box-shadow:0 0 20px ${p.color}">${p.icon}</div><div><h2 style="color:${p.color}">${p.name}</h2><p>${p.description}</p></div></div><div class="component-grid">${p.components.map(c=>`<div class="component-card" data-component="${c.id}" style="--card-accent:${p.color}" onclick="enterCore('${id}','${c.id}')"><h3><span class="icon">${c.icon}</span> ${c.name}</h3><div class="card-desc">${c.desc}</div><div class="card-tags">${(c.tags||[]).map(t=>`<span class="card-tag">${t}</span>`).join("")}${(c.triggerTags||[]).map(t=>`<span class="card-tag trigger">${t}</span>`).join("")}</div></div>`).join("")}</div><div class="data-flow"><h3>\u{1F500} Data Flow</h3><div class="flow-diagram">${p.dataFlow.map((n,i)=>(i>0?'<span class="flow-arrow">\u2192</span>':"")+`<span class="flow-node">${n}</span>`).join("")}</div></div><div class="connections-section"><h3>\u{1F30C} Connected Systems</h3>${p.connections.map(c=>`<div class="connection-item" onclick="enterPlanet('${c.planet}')"><div class="conn-planet" style="background:${PLANET_META[c.planet]?.color||"#64748b"}">${PLANET_META[c.planet]?.icon||"\u{2B50}"}</div><div><strong>${NPSP[c.planet]?.name||c.planet}</strong><div style="color:var(--text-dim);font-size:9px;margin-top:2px">${c.desc}</div></div></div>`).join("")}</div>`;document.getElementById("planet-view").scrollTop=0}

// ── Render Core ──
function renderCoreView(pid,cid){const p=NPSP[pid],c=p.components.find(x=>x.id===cid);if(!c)return;const el=document.getElementById("core-content");let h=`<div class="core-header"><span style="font-size:22px">${c.icon}</span><div><h2>${c.name}</h2><span class="badge">TRIGGER LEVEL</span></div></div><div class="trigger-section"><h3>\u{1F4CB} Overview</h3><div class="trigger-desc">${c.desc}</div><div class="card-tags">${(c.tags||[]).map(t=>`<span class="card-tag">${t}</span>`).join("")}${(c.triggerTags||[]).map(t=>`<span class="card-tag trigger">${t}</span>`).join("")}</div></div>`;if(c.executionFlow)h+=`<div class="trigger-section"><h3>\u{26A1} Execution Flow</h3><div class="execution-flow">${c.executionFlow.map((s,i)=>`<div class="exec-step"><span class="step-num">${i+1}</span><span>${s}</span></div>`).join("")}</div></div>`;if(c.code)h+=`<div class="trigger-section"><h3>\u{1F4BB} Source Code Pattern</h3><div class="code-block"><div class="code-header"><span class="lang">${c.code.lang}</span><span>${c.code.title}</span><button class="copy-btn" onclick="copyCode(this)">Copy</button></div><div class="code-body"><pre>${c.code.body}</pre></div></div></div>`;h+=`<div class="code-lab"><h3>\u{1F9EA} Code Lab: Explore Further</h3><div class="lab-desc">Related patterns for understanding this component deeper.</div><div class="lab-tabs"><button class="lab-tab active" onclick="switchTab(this,'pattern')">TDTM Pattern</button><button class="lab-tab" onclick="switchTab(this,'testing')">Test Pattern</button><button class="lab-tab" onclick="switchTab(this,'extension')">Extension Point</button></div><div id="lab-content"></div></div>`;el.innerHTML=h;switchTab(el.querySelector(".lab-tab.active"),"pattern");document.getElementById("core-view").scrollTop=0}

const labPatterns={pattern:{title:"TDTM Handler Pattern",code:'<span class="cm">// Create a custom TDTM handler</span>\n<span class="kw">public class</span> <span class="ty">MyCustomHandler</span>\n  <span class="kw">extends</span> <span class="ty">TDTM_Runnable</span> {\n\n  <span class="kw">public override</span> <span class="ty">DmlWrapper</span> <span class="fn">run</span>(\n    <span class="ty">List&lt;SObject&gt;</span> newList,\n    <span class="ty">List&lt;SObject&gt;</span> oldList,\n    <span class="ty">TDTM_Runnable.Action</span> triggerAction,\n    <span class="ty">Schema.DescribeSObjectResult</span> objResult\n  ) {\n    <span class="kw">if</span> (triggerAction == <span class="ty">Action</span>.AfterInsert) {\n      <span class="kw">for</span> (<span class="ty">SObject</span> record : newList) {\n        <span class="cm">// Custom logic here</span>\n      }\n    }\n    <span class="kw">return null</span>;\n  }\n}\n\n<span class="cm">// Or extend TDTM_RunnableMutable for</span>\n<span class="cm">// handlers that need to mutate records</span>'},testing:{title:"Test Pattern for TDTM Handlers",code:'<span class="an">@isTest</span>\n<span class="kw">private class</span> <span class="ty">MyHandler_TEST</span> {\n\n  <span class="an">@testSetup</span>\n  <span class="kw">static void</span> <span class="fn">setup</span>() {\n    <span class="ty">UTIL_UnitTestData_TEST</span>\n      .<span class="fn">createDefaultSettings</span>();\n  }\n\n  <span class="an">@isTest</span>\n  <span class="kw">static void</span> <span class="fn">testHandler</span>() {\n    <span class="ty">Contact</span> c = <span class="ty">UTIL_UnitTestData_TEST</span>\n      .<span class="fn">createTestContact</span>();\n\n    <span class="ty">Test</span>.startTest();\n    <span class="ty">Opportunity</span> opp = <span class="kw">new</span> <span class="ty">Opportunity</span>(\n      ContactId = c.Id,\n      Amount = <span class="nu">100</span>,\n      CloseDate = <span class="ty">Date</span>.today(),\n      StageName = <span class="st">\'Closed Won\'</span>,\n      Name = <span class="st">\'Test\'</span>\n    );\n    <span class="kw">insert</span> opp;\n    <span class="ty">Test</span>.stopTest();\n\n    opp = [<span class="kw">SELECT</span> Name <span class="kw">FROM</span> <span class="ty">Opportunity</span>\n           <span class="kw">WHERE</span> Id = :opp.Id];\n    <span class="ty">System</span>.assertNotEquals(\n      <span class="st">\'Test\'</span>, opp.Name);\n  }\n}'},extension:{title:"Extension Point: Custom Logic",code:'<span class="cm">// Extend NPSP without modifying its code</span>\n\n<span class="cm">// Option 1: Custom TDTM handler (recommended)</span>\n<span class="ty">npsp__Trigger_Handler__c</span> handler =\n  <span class="kw">new</span> <span class="ty">npsp__Trigger_Handler__c</span>(\n    npsp__Class__c = <span class="st">\'MyCustomHandler\'</span>,\n    npsp__Object__c = <span class="st">\'Opportunity\'</span>,\n    npsp__Trigger_Action__c =\n      <span class="st">\'AfterInsert;AfterUpdate\'</span>,\n    npsp__Load_Order__c = <span class="nu">99</span>,\n    npsp__Active__c = <span class="kw">true</span>,\n    npsp__User_Managed__c = <span class="kw">true</span>\n      <span class="cm">// Prevents NPSP from overwriting</span>\n  );\n<span class="kw">insert</span> handler;\n\n<span class="cm">// Option 2: Flow / Process Builder</span>\n<span class="cm">// Runs after all TDTM handlers</span>\n\n<span class="cm">// Option 3: Custom Rollup (CMDT)</span>\n<span class="cm">// Via NPSP Settings UI, no code</span>'}};

function switchTab(tab,type){tab.parentElement.querySelectorAll(".lab-tab").forEach(t=>t.classList.remove("active"));tab.classList.add("active");const p=labPatterns[type];document.getElementById("lab-content").innerHTML=`<div class="code-block"><div class="code-header"><span class="lang">Apex</span><span>${p.title}</span><button class="copy-btn" onclick="copyCode(this)">Copy</button></div><div class="code-body"><pre>${p.code}</pre></div></div>`}

function copyCode(btn){const pre=btn.closest(".code-block").querySelector("pre");navigator.clipboard.writeText(pre.textContent).then(()=>{btn.textContent="Copied!";setTimeout(()=>btn.textContent="Copy",1500)})}

// ══════════════════════════════════════════════════════════════
//  SEARCH ENGINE
// ══════════════════════════════════════════════════════════════
let searchResults=[],searchIndex=-1;

function buildSearchIndex(){const idx=[];for(const[pid,planet] of Object.entries(NPSP)){idx.push({type:"planet",id:pid,name:planet.name,desc:planet.description,icon:planet.icon,color:planet.color,tags:[],level:"Galaxy",action:()=>enterPlanet(pid)});for(const comp of planet.components){const allTags=[...(comp.tags||[]),...(comp.triggerTags||[])];idx.push({type:"component",id:comp.id,planetId:pid,name:comp.name,desc:comp.desc,icon:comp.icon,color:planet.color,tags:allTags,level:planet.name,action:()=>{if(currentPlanet!==pid)enterPlanet(pid);setTimeout(()=>enterCore(pid,comp.id),currentPlanet!==pid?900:0)}});for(const tag of allTags){idx.push({type:"tag",id:tag,planetId:pid,componentId:comp.id,name:tag,desc:comp.desc,icon:comp.icon,color:planet.color,tags:[],level:planet.name+" > "+comp.name,action:()=>{if(currentPlanet!==pid)enterPlanet(pid);setTimeout(()=>enterCore(pid,comp.id),currentPlanet!==pid?900:0)}})}}}return idx}

const fullIndex=buildSearchIndex();

function searchNPSP(query){if(!query.trim())return[];const q=query.toLowerCase();const scored=[];for(const item of fullIndex){let score=0;const nm=item.name.toLowerCase(),ds=item.desc.toLowerCase(),tgs=item.tags.map(t=>t.toLowerCase());if(nm===q)score+=100;else if(nm.startsWith(q))score+=80;else if(nm.includes(q))score+=60;if(ds.includes(q))score+=30;for(const t of tgs){if(t===q)score+=90;else if(t.includes(q))score+=50}if(score>0)scored.push({...item,score})}scored.sort((a,b)=>b.score-a.score);const seen=new Set,deduped=[];for(const r of scored){const key=r.type+":"+r.id+(r.planetId||"");if(!seen.has(key)){seen.add(key);deduped.push(r);if(deduped.length>=25)break}}return deduped}

function highlightMatch(text,query){if(!query)return text;const re=new RegExp(`(${query.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")})`,"gi");return text.replace(re,'<span class="sr-match">$1</span>')}

function renderSearchResults(results,query){const el=document.getElementById("searchResults");if(results.length===0&&query.trim()){el.innerHTML='<div style="text-align:center;padding:24px;color:var(--text-dim);font-size:11px">No results for "'+query.replace(/</g,"&lt;")+'"</div>';return}el.innerHTML=results.map((r,i)=>`<div class="search-result${i===searchIndex?" active":""}" data-idx="${i}" onclick="activateResult(${i})" onmouseenter="searchIndex=${i};highlightActive()"><div class="sr-icon" style="background:${r.color}22;border:1px solid ${r.color}44">${r.icon}</div><div class="sr-body"><div class="sr-title">${highlightMatch(r.name,query)}</div><div class="sr-path">${r.level}</div><div class="sr-desc">${highlightMatch(r.desc.substring(0,100),query)}${r.desc.length>100?"...":""}</div></div><span class="sr-level">${r.type}</span></div>`).join("")}

function highlightActive(){document.querySelectorAll(".search-result").forEach((el,i)=>el.classList.toggle("active",i===searchIndex))}

function activateResult(idx){const r=searchResults[idx];if(r){closeSearch();setTimeout(()=>{r.action();if(r.type==="planet"){setTimeout(()=>{const pe=document.querySelector(`.planet[data-planet="${r.id}"]`);if(pe){pe.classList.add("highlight");setTimeout(()=>pe.classList.remove("highlight"),2000)}},100)}},100)}}

function cycleResult(dir){if(searchResults.length===0)return;searchIndex=(searchIndex+dir+searchResults.length)%searchResults.length;highlightActive();document.getElementById("searchCount").textContent=`${searchIndex+1}/${searchResults.length}`;const active=document.querySelector(".search-result.active");if(active)active.scrollIntoView({block:"nearest"})}

function openSearch(){const ov=document.getElementById("search-overlay");ov.classList.add("open");const inp=document.getElementById("searchInput");inp.value="";inp.focus();searchResults=[];searchIndex=-1;document.getElementById("searchResults").innerHTML="";document.getElementById("searchNav").style.display="none"}

function closeSearch(){document.getElementById("search-overlay").classList.remove("open");document.querySelectorAll(".planet.highlight,.component-card.highlight").forEach(e=>e.classList.remove("highlight"))}

document.getElementById("searchInput").addEventListener("input",function(){const q=this.value;searchResults=searchNPSP(q);searchIndex=searchResults.length>0?0:-1;renderSearchResults(searchResults,q);const nav=document.getElementById("searchNav");if(searchResults.length>0){nav.style.display="flex";document.getElementById("searchCount").textContent=`${searchIndex+1}/${searchResults.length}`}else{nav.style.display="none"}});

document.getElementById("searchInput").addEventListener("keydown",function(e){if(e.key==="Enter"){e.preventDefault();if(e.shiftKey)cycleResult(-1);else if(searchResults.length>0&&searchIndex>=0)activateResult(searchIndex);else cycleResult(1)}if(e.key==="ArrowDown"){e.preventDefault();cycleResult(1)}if(e.key==="ArrowUp"){e.preventDefault();cycleResult(-1)}if(e.key==="Escape"){closeSearch()}});

// ── Keyboard shortcuts ──
document.addEventListener("keydown",e=>{if(e.key==="/"&&!document.getElementById("search-overlay").classList.contains("open")&&document.activeElement.tagName!=="INPUT"){e.preventDefault();openSearch()}if(e.key==="Escape"&&!document.getElementById("search-overlay").classList.contains("open")){goBack()}});

initStarfield();
updateBreadcrumb();
</script>
</body>
</html>
